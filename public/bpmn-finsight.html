<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Process Designer - FinSight Intelligence</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/@blueprintjs/core@4.20.2/lib/css/blueprint.css" rel="stylesheet">
    <link href="apple-hybrid-safe.css" rel="stylesheet">
    
    <!-- BPMN.js Modeler CSS -->
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@11.5.0/dist/assets/diagram-js.css">
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@11.5.0/dist/assets/bpmn-font/css/bpmn.css">
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js-properties-panel@1.22.0/dist/assets/properties-panel.css">
    
    <style>
        /* Use the same design system as model-jobs.html */
        :root {
            --jobs-black: #000000;
            --jobs-white: #FFFFFF;
            --jobs-gray: #8E8E93;
            --jobs-light-gray: #F2F2F7;
            --jobs-blue: #007AFF;
            --jobs-green: #34C759;
            --jobs-red: #FF3B30;
            --jobs-orange: #FF9500;
            --jobs-purple: #AF52DE;
            --jobs-teal: #5AC8FA;
            --jobs-pink: #FF2D92;
            
            --jobs-font: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", sans-serif;
            --jobs-font-size-hero: 48px;
            --jobs-font-size-title: 34px;
            --jobs-font-size-headline: 28px;
            --jobs-font-size-body: 17px;
            --jobs-font-size-caption: 13px;
            
            --jobs-spacing-xs: 4px;
            --jobs-spacing-sm: 8px;
            --jobs-spacing-md: 16px;
            --jobs-spacing-lg: 24px;
            --jobs-spacing-xl: 32px;
            --jobs-spacing-xxl: 48px;
            
            --jobs-animation: cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --jobs-duration: 300ms;
        }
        
        * {
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body {
            margin: 0;
            font-family: var(--jobs-font);
            font-size: var(--jobs-font-size-body);
            color: var(--jobs-black);
            background: var(--jobs-white);
            line-height: 1.47;
            overflow: hidden;
        }
        
        body.dark-mode {
            background: var(--jobs-black);
            color: var(--jobs-white);
        }
        
        /* Navigation matching model-jobs.html */
        .jobs-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            align-items: center;
            padding: 0 var(--jobs-spacing-lg);
        }
        
        body.dark-mode .jobs-nav {
            background: rgba(0, 0, 0, 0.8);
            border-bottom-color: rgba(255, 255, 255, 0.1);
        }
        
        .jobs-nav-title {
            font-size: 20px;
            font-weight: 600;
            margin-right: auto;
        }
        
        .jobs-nav-actions {
            display: flex;
            gap: var(--jobs-spacing-sm);
        }
        
        .jobs-action-button {
            padding: 8px 16px;
            background: var(--jobs-blue);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--jobs-duration) var(--jobs-animation);
        }
        
        .jobs-action-button:hover {
            background: #0051D5;
            transform: translateY(-1px);
        }
        
        .jobs-action-button.secondary {
            background: transparent;
            color: var(--jobs-blue);
            border: 1px solid var(--jobs-blue);
        }
        
        body.dark-mode .jobs-action-button.secondary {
            color: var(--jobs-blue);
            border-color: var(--jobs-blue);
        }
        
        /* Main Layout */
        .main-container {
            display: flex;
            height: calc(100vh - 56px);
            margin-top: 56px;
        }
        
        /* Left Sidebar - Process Templates & Palette */
        .jobs-sidebar {
            width: 320px;
            background: var(--jobs-light-gray);
            border-right: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        body.dark-mode .jobs-sidebar {
            background: #1C1C1E;
            border-right-color: #38383A;
        }
        
        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            background: white;
        }
        
        /* Agent Cards */
        .agent-card-detailed {
            background: white;
            border-radius: 12px;
            padding: var(--jobs-spacing-md);
            margin-bottom: var(--jobs-spacing-md);
            border: 1px solid rgba(0, 0, 0, 0.1);
            transition: all var(--jobs-duration) var(--jobs-animation);
        }
        
        body.dark-mode .agent-card-detailed {
            background: #2C2C2E;
            border-color: #38383A;
        }
        
        .agent-card-detailed:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        
        .agent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .agent-title {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
        }
        
        .agent-type-badge {
            background: var(--jobs-blue);
            color: white;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .agent-metadata {
            font-size: 13px;
            color: var(--jobs-gray);
            margin-bottom: 12px;
        }
        
        .agent-io-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        body.dark-mode .agent-io-section {
            border-top-color: #38383A;
        }
        
        .io-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--jobs-gray);
            text-transform: uppercase;
            margin-bottom: 6px;
        }
        
        .io-param {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            font-size: 13px;
        }
        
        .io-param-name {
            font-weight: 500;
        }
        
        .io-param-type {
            color: var(--jobs-blue);
            font-family: monospace;
            font-size: 12px;
        }
        
        .agent-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .agent-action-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--jobs-blue);
            color: var(--jobs-blue);
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .agent-action-btn:hover {
            background: var(--jobs-blue);
            color: white;
        }
        
        /* Agent Internal View Modal */
        .agent-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .agent-modal.active {
            display: flex;
        }
        
        .agent-modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 1200px;
            height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        body.dark-mode .agent-modal-content {
            background: #1C1C1E;
        }
        
        .agent-modal-header {
            padding: var(--jobs-spacing-lg);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        body.dark-mode .agent-modal-header {
            border-bottom-color: #38383A;
        }
        
        .agent-modal-title {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
        }
        
        .agent-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--jobs-gray);
        }
        
        .agent-modal-body {
            flex: 1;
            padding: var(--jobs-spacing-lg);
            overflow-y: auto;
        }
        
        #agent-internal-canvas {
            width: 100%;
            height: 400px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            margin-bottom: var(--jobs-spacing-lg);
        }
        
        body.dark-mode #agent-internal-canvas {
            border-color: #38383A;
        }
        
        body.dark-mode .sidebar-tabs {
            background: #2C2C2E;
            border-bottom-color: #38383A;
        }
        
        .sidebar-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            color: var(--jobs-gray);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .sidebar-tab:hover {
            color: var(--jobs-black);
        }
        
        body.dark-mode .sidebar-tab:hover {
            color: white;
        }
        
        .sidebar-tab.active {
            color: var(--jobs-blue);
            border-bottom-color: var(--jobs-blue);
        }
        
        .sidebar-content {
            flex: 1;
            padding: var(--jobs-spacing-lg);
            overflow-y: auto;
        }
        
        /* BPMN Palette */
        .palette-section {
            margin-bottom: var(--jobs-spacing-lg);
        }
        
        .palette-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--jobs-gray);
            text-transform: uppercase;
            margin-bottom: var(--jobs-spacing-sm);
        }
        
        .palette-items {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--jobs-spacing-sm);
        }
        
        .palette-item {
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: move;
            transition: all 0.2s;
            user-select: none;
        }
        
        body.dark-mode .palette-item {
            background: #2C2C2E;
            border-color: #38383A;
        }
        
        .palette-item:hover {
            background: var(--jobs-blue);
            color: white;
            transform: scale(1.05);
        }
        
        .palette-item-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }
        
        .palette-item-label {
            font-size: 11px;
        }
        
        /* Template Cards */
        .template-card {
            background: white;
            border-radius: 12px;
            padding: var(--jobs-spacing-md);
            margin-bottom: var(--jobs-spacing-md);
            cursor: pointer;
            transition: all var(--jobs-duration) var(--jobs-animation);
            border: 2px solid transparent;
        }
        
        body.dark-mode .template-card {
            background: #2C2C2E;
        }
        
        .template-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }
        
        .template-card.active {
            border-color: var(--jobs-blue);
            background: rgba(0, 122, 255, 0.05);
        }
        
        .template-card h3 {
            font-size: 17px;
            font-weight: 600;
            margin: 0 0 8px;
        }
        
        .template-card p {
            font-size: 14px;
            color: var(--jobs-gray);
            margin: 0 0 12px;
            line-height: 1.4;
        }
        
        .template-agents {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .agent-chip {
            background: rgba(0, 122, 255, 0.1);
            color: var(--jobs-blue);
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
        }
        
        /* Canvas Area */
        .canvas-container {
            flex: 1;
            background: white;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        body.dark-mode .canvas-container {
            background: #000;
        }
        
        .canvas-toolbar {
            background: var(--jobs-light-gray);
            padding: var(--jobs-spacing-sm) var(--jobs-spacing-md);
            display: flex;
            align-items: center;
            gap: var(--jobs-spacing-md);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        body.dark-mode .canvas-toolbar {
            background: #1C1C1E;
            border-bottom-color: #38383A;
        }
        
        .toolbar-group {
            display: flex;
            gap: var(--jobs-spacing-sm);
        }
        
        .toolbar-button {
            padding: 6px 12px;
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all var(--jobs-duration) var(--jobs-animation);
        }
        
        body.dark-mode .toolbar-button {
            background: #2C2C2E;
            border-color: #38383A;
            color: white;
        }
        
        .toolbar-button:hover {
            background: var(--jobs-blue);
            color: white;
            border-color: var(--jobs-blue);
        }
        
        #canvas {
            flex: 1;
            position: relative;
        }
        
        /* Right Panel - Properties */
        .properties-panel {
            width: 360px;
            background: var(--jobs-light-gray);
            border-left: 1px solid rgba(0, 0, 0, 0.1);
            padding: var(--jobs-spacing-lg);
            overflow-y: auto;
        }
        
        body.dark-mode .properties-panel {
            background: #1C1C1E;
            border-left-color: #38383A;
        }
        
        .properties-section {
            margin-bottom: var(--jobs-spacing-xl);
        }
        
        .properties-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: var(--jobs-spacing-md);
        }
        
        .property-field {
            margin-bottom: var(--jobs-spacing-md);
        }
        
        .property-label {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--jobs-gray);
        }
        
        .property-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            font-size: 15px;
            background: white;
        }
        
        body.dark-mode .property-input {
            background: #2C2C2E;
            border-color: #38383A;
            color: white;
        }
        
        /* BPMN.js Custom Styles */
        .djs-container {
            background: white !important;
        }
        
        body.dark-mode .djs-container {
            background: #000 !important;
        }
        
        /* Override BPMN.js palette to hide it (we use custom palette) */
        .djs-palette {
            display: none !important;
        }
        
        /* Custom colors for financial processes */
        .highlight-news {
            fill: #E8F5E9 !important;
            stroke: #4CAF50 !important;
        }
        
        .highlight-risk {
            fill: #FFF3E0 !important;
            stroke: #FF9800 !important;
        }
        
        .highlight-trading {
            fill: #E3F2FD !important;
            stroke: #2196F3 !important;
        }
        
        .highlight-compliance {
            fill: #FCE4EC !important;
            stroke: #E91E63 !important;
        }
        
        /* Properties panel override */
        .bio-properties-panel {
            width: 100% !important;
            position: relative !important;
            border: none !important;
            box-shadow: none !important;
        }
        
        .bio-properties-panel-header {
            display: none !important;
        }
        
        /* Loading states */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-top-color: var(--jobs-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        body.dark-mode .loading-spinner {
            border-color: rgba(255, 255, 255, 0.1);
            border-top-color: var(--jobs-blue);
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes slideUp {
            from {
                transform: translate(-50%, 100%);
                opacity: 0;
            }
            to {
                transform: translate(-50%, 0);
                opacity: 1;
            }
        }
        
        @keyframes slideDown {
            from {
                transform: translate(-50%, 0);
                opacity: 1;
            }
            to {
                transform: translate(-50%, 100%);
                opacity: 0;
            }
        }
        
        /* Process validation indicator */
        .validation-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 6px 12px;
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        body.dark-mode .validation-indicator {
            background: #2C2C2E;
            border-color: #38383A;
        }
        
        .validation-indicator.valid {
            border-color: var(--jobs-green);
            color: var(--jobs-green);
        }
        
        .validation-indicator.invalid {
            border-color: var(--jobs-red);
            color: var(--jobs-red);
        }
        
        /* Keyboard shortcuts hint */
        .keyboard-hint {
            position: absolute;
            bottom: 10px;
            left: 10px;
            font-size: 11px;
            color: var(--jobs-gray);
            opacity: 0.7;
        }
        /* Animations */
        @keyframes slideUp {
            from {
                transform: translateX(-50%) translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
            to {
                transform: translateX(-50%) translateY(100%);
                opacity: 0;
            }
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        /* Loading spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Validation indicator */
        .validation-indicator {
            position: absolute;
            bottom: 20px;
            right: 20px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 100;
            transition: all 0.3s ease;
        }
        
        .validation-indicator.valid {
            color: var(--jobs-green);
            border: 1px solid var(--jobs-green);
        }
        
        .validation-indicator.invalid {
            color: var(--jobs-red);
            border: 1px solid var(--jobs-red);
        }
        
        body.dark-mode .validation-indicator {
            background: rgba(0, 0, 0, 0.9);
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="jobs-nav">
        <div class="jobs-nav-title">Process Designer</div>
        <div class="jobs-nav-actions">
            <button class="jobs-action-button secondary" onclick="saveProcess()">Save Process</button>
            <button class="jobs-action-button" onclick="zeroConfigDeploy()" style="background: linear-gradient(135deg, var(--jobs-green), var(--jobs-teal)); color: white;">
                üöÄ Zero-Config Deploy
            </button>
        </div>
    </nav>
    
    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Sidebar - Palette & Templates -->
        <aside class="jobs-sidebar">
            <div class="sidebar-tabs">
                <div class="sidebar-tab active" onclick="showSidebarTab('palette')">Elements</div>
                <div class="sidebar-tab" onclick="showSidebarTab('templates')">Templates</div>
                <div class="sidebar-tab" onclick="showSidebarTab('agents')">Agents</div>
            </div>
            
            <div class="sidebar-content" id="sidebar-palette">
                <!-- Events -->
                <div class="palette-section">
                    <div class="palette-title">Events</div>
                    <div class="palette-items">
                        <div class="palette-item" draggable="true" data-element-type="start-event">
                            <div class="palette-item-icon">‚≠ï</div>
                            <div class="palette-item-label">Start</div>
                        </div>
                        <div class="palette-item" draggable="true" data-element-type="end-event">
                            <div class="palette-item-icon">‚≠ï</div>
                            <div class="palette-item-label">End</div>
                        </div>
                        <div class="palette-item" draggable="true" data-element-type="timer-event">
                            <div class="palette-item-icon">‚è∞</div>
                            <div class="palette-item-label">Timer</div>
                        </div>
                    </div>
                </div>
                
                <!-- Tasks -->
                <div class="palette-section">
                    <div class="palette-title">Tasks</div>
                    <div class="palette-items">
                        <div class="palette-item" draggable="true" data-element-type="task">
                            <div class="palette-item-icon">‚ñ¢</div>
                            <div class="palette-item-label">Task</div>
                        </div>
                        <div class="palette-item" draggable="true" data-element-type="user-task">
                            <div class="palette-item-icon">üë§</div>
                            <div class="palette-item-label">User Task</div>
                        </div>
                        <div class="palette-item" draggable="true" data-element-type="service-task">
                            <div class="palette-item-icon">‚öôÔ∏è</div>
                            <div class="palette-item-label">Service</div>
                        </div>
                    </div>
                </div>
                
                <!-- Gateways -->
                <div class="palette-section">
                    <div class="palette-title">Gateways</div>
                    <div class="palette-items">
                        <div class="palette-item" draggable="true" data-element-type="exclusive-gateway">
                            <div class="palette-item-icon">‚óá</div>
                            <div class="palette-item-label">Exclusive</div>
                        </div>
                        <div class="palette-item" draggable="true" data-element-type="parallel-gateway">
                            <div class="palette-item-icon">‚óá</div>
                            <div class="palette-item-label">Parallel</div>
                        </div>
                        <div class="palette-item" draggable="true" data-element-type="event-gateway">
                            <div class="palette-item-icon">‚óá</div>
                            <div class="palette-item-label">Event</div>
                        </div>
                    </div>
                </div>
                
                <!-- Pools & Lanes -->
                <div class="palette-section">
                    <div class="palette-title">Containers</div>
                    <div class="palette-items">
                        <div class="palette-item" draggable="true" data-element-type="participant">
                            <div class="palette-item-icon">‚ñ≠</div>
                            <div class="palette-item-label">Pool</div>
                        </div>
                        <div class="palette-item" draggable="true" data-element-type="lane">
                            <div class="palette-item-icon">‚îÅ</div>
                            <div class="palette-item-label">Lane</div>
                        </div>
                        <div class="palette-item" draggable="true" data-element-type="subprocess">
                            <div class="palette-item-icon">‚ñ¢</div>
                            <div class="palette-item-label">Subprocess</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-content" id="sidebar-templates" style="display: none;">
                <div class="template-card" onclick="loadTemplate('market-sentiment')">
                    <h3>Market Sentiment Analysis</h3>
                    <p>Monitors news sentiment and triggers risk adjustments when thresholds are breached</p>
                    <div class="template-agents">
                        <span class="agent-chip">News Sentiment Tracker</span>
                        <span class="agent-chip">Risk Calculator</span>
                        <span class="agent-chip">Portfolio Optimizer</span>
                    </div>
                </div>
                
                <div class="template-card" onclick="loadTemplate('portfolio-rebalancing')">
                    <h3>Portfolio Rebalancing Review</h3>
                    <p>Multi-stage approval for major portfolio changes with risk analysis</p>
                    <div class="template-agents">
                        <span class="agent-chip">Portfolio Optimizer</span>
                        <span class="agent-chip">Scenario Analyzer</span>
                        <span class="agent-chip">Financial Advisor</span>
                        <span class="agent-chip">Compliance Officer</span>
                    </div>
                </div>
                
                <div class="template-card" onclick="loadTemplate('fx-risk-hedge')">
                    <h3>FX Risk Hedging</h3>
                    <p>Automatic currency hedging when exposure exceeds limits</p>
                    <div class="template-agents">
                        <span class="agent-chip">FX Analyzer</span>
                        <span class="agent-chip">Risk Calculator</span>
                        <span class="agent-chip">Trading Strategy</span>
                    </div>
                </div>
                
                <div class="template-card" onclick="loadTemplate('compliance-check')">
                    <h3>Trade Compliance Workflow</h3>
                    <p>Pre-trade compliance checks with escalation for large trades</p>
                    <div class="template-agents">
                        <span class="agent-chip">Compliance Officer</span>
                        <span class="agent-chip">Credit Risk Agent</span>
                        <span class="agent-chip">Financial Controller</span>
                    </div>
                </div>
            </div>
            
            <div class="sidebar-content" id="sidebar-agents" style="display: none;">
                <div id="agent-list">
                    <!-- Agents will be loaded here dynamically -->
                    <div style="text-align: center; padding: 40px;">
                        <p style="color: var(--jobs-gray);">Loading agents...</p>
                    </div>
                </div>
            </div>
        </aside>
        
        <!-- Canvas Area -->
        <div class="canvas-container">
            <div class="canvas-toolbar">
                <div class="toolbar-group">
                    <button class="toolbar-button" onclick="undo()">‚Ü∂ Undo</button>
                    <button class="toolbar-button" onclick="redo()">‚Ü∑ Redo</button>
                </div>
                <div class="toolbar-group">
                    <button class="toolbar-button" onclick="zoomIn()">Zoom In</button>
                    <button class="toolbar-button" onclick="zoomOut()">Zoom Out</button>
                    <button class="toolbar-button" onclick="fitDiagram()">Fit to Screen</button>
                </div>
                <div class="toolbar-group">
                    <button class="toolbar-button" onclick="exportBPMN()">Export BPMN</button>
                    <button class="toolbar-button" onclick="exportImage()">Export Image</button>
                </div>
                <div class="toolbar-group">
                    <button class="toolbar-button ai-powered" onclick="optimizeWithAI()" style="background: linear-gradient(135deg, var(--jobs-purple), var(--jobs-pink)); color: white;">
                        ‚ú® AI Optimize
                    </button>
                    <button class="toolbar-button" onclick="startCollaboration()" style="background: var(--jobs-blue); color: white;">
                        üë• Collaborate
                    </button>
                </div>
            </div>
            <div id="canvas"></div>
        </div>
        
        <!-- Right Panel - Properties -->
        <aside class="properties-panel">
            <div class="properties-section">
                <h3 class="properties-title">Process Information</h3>
                <div class="property-field">
                    <div class="property-label">Process Name</div>
                    <input type="text" class="property-input" id="process-name" value="New Financial Process">
                </div>
                <div class="property-field">
                    <div class="property-label">Description</div>
                    <input type="text" class="property-input" id="process-desc" value="Enter process description">
                </div>
            </div>
            
            <div class="properties-section">
                <h3 class="properties-title">Selected Element</h3>
                <div id="element-properties">
                    <p style="color: var(--jobs-gray); font-size: 14px;">Select an element to view properties</p>
                </div>
            </div>
            
            <div class="properties-section">
                <h3 class="properties-title">Available Agents</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                    <span class="agent-chip">News Sentiment Tracker</span>
                    <span class="agent-chip">Market Data Collector</span>
                    <span class="agent-chip">Portfolio Optimizer</span>
                    <span class="agent-chip">Risk Calculator</span>
                    <span class="agent-chip">Scenario Analyzer</span>
                    <span class="agent-chip">Trading Strategy</span>
                    <span class="agent-chip">Compliance Officer</span>
                    <span class="agent-chip">Financial Advisor</span>
                    <span class="agent-chip">FX Analyzer</span>
                    <span class="agent-chip">Credit Risk Agent</span>
                </div>
            </div>
        </aside>
    </div>
    
    <!-- Agent Internal View Modal -->
    <div class="agent-modal" id="agent-modal">
        <div class="agent-modal-content">
            <div class="agent-modal-header">
                <h2 class="agent-modal-title" id="agent-modal-title">Agent Internal Process</h2>
                <button class="agent-modal-close" onclick="closeAgentModal()">√ó</button>
            </div>
            <div class="agent-modal-body">
                <div id="agent-internal-canvas"></div>
                <div id="agent-metadata-display">
                    <!-- Agent metadata will be displayed here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- BPMN.js Scripts -->
    <script src="https://unpkg.com/bpmn-js@11.5.0/dist/bpmn-modeler.production.min.js"></script>
    <script src="https://unpkg.com/bpmn-js-properties-panel@1.22.0/dist/index.js"></script>
    <script>
        let modeler;
        let commandStack;
        
        // Initialize empty BPMN
        const emptyBPMN = `<?xml version="1.0" encoding="UTF-8"?>
<bpmn2:definitions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:bpmn2="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" id="diagram" targetNamespace="http://bpmn.io/schema/bpmn">
  <bpmn2:process id="Process_1" isExecutable="true">
    <bpmn2:startEvent id="StartEvent_1">
      <bpmn2:outgoing>Flow_1</bpmn2:outgoing>
    </bpmn2:startEvent>
    <bpmn2:task id="Task_1" name="New Task">
      <bpmn2:incoming>Flow_1</bpmn2:incoming>
      <bpmn2:outgoing>Flow_2</bpmn2:outgoing>
    </bpmn2:task>
    <bpmn2:endEvent id="EndEvent_1">
      <bpmn2:incoming>Flow_2</bpmn2:incoming>
    </bpmn2:endEvent>
    <bpmn2:sequenceFlow id="Flow_1" sourceRef="StartEvent_1" targetRef="Task_1" />
    <bpmn2:sequenceFlow id="Flow_2" sourceRef="Task_1" targetRef="EndEvent_1" />
  </bpmn2:process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_1">
      <bpmndi:BPMNShape id="StartEvent_1_di" bpmnElement="StartEvent_1">
        <dc:Bounds x="180" y="180" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Task_1_di" bpmnElement="Task_1">
        <dc:Bounds x="280" y="158" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="EndEvent_1_di" bpmnElement="EndEvent_1">
        <dc:Bounds x="450" y="180" width="36" height="36" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Flow_1_di" bpmnElement="Flow_1">
        <di:waypoint x="216" y="198" />
        <di:waypoint x="280" y="198" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_2_di" bpmnElement="Flow_2">
        <di:waypoint x="380" y="198" />
        <di:waypoint x="450" y="198" />
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn2:definitions>`;
        
        // Initialize the modeler
        function initModeler() {
            try {
                modeler = new BpmnJS({
                    container: '#canvas',
                    keyboard: {
                        bindTo: document
                    },
                    moddleExtensions: {
                        a2a: {
                            name: 'A2A',
                            uri: 'http://a2a.finsight/schema/1.0',
                            prefix: 'a2a'
                        },
                        ord: {
                            name: 'ORD',
                            uri: 'http://sap.com/open-resource-discovery/1.0',
                            prefix: 'ord'
                        }
                    }
                });
                
                // Get command stack for undo/redo
                commandStack = modeler.get('commandStack');
                
                // Add error handling for modeler
                const eventBus = modeler.get('eventBus');
                eventBus.on('import.parse.failed', (event) => {
                    console.error('BPMN parse failed:', event.error);
                    showNotification('Failed to parse BPMN diagram', 'error');
                });
                
                eventBus.on('import.render.failed', (event) => {
                    console.error('BPMN render failed:', event.error);
                    showNotification('Failed to render BPMN diagram', 'error');
                });
                
                // Load empty diagram with error handling
                modeler.importXML(emptyBPMN).then(() => {
                    modeler.get('canvas').zoom('fit-viewport');
                    setupEventHandlers();
                    
                    // Enable auto-save
                    enableAutoSave();
                    
                    // Enable real-time validation
                    enableRealTimeValidation();
                    
                    // Check for recovered diagram
                    checkForRecoveredDiagram();
                    
                    // Initial validation after 1 second
                    setTimeout(() => validateProcess(), 1000);
                    
                    showNotification('BPMN Designer loaded successfully! You can now design A2A agent processes.', 'success');
                }).catch(error => {
                    console.error('Failed to initialize modeler:', error);
                    showNotification('Failed to initialize process designer', 'error');
                });
            } catch (error) {
                console.error('Modeler initialization error:', error);
                document.getElementById('canvas').innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--jobs-red);">
                        <div style="text-align: center;">
                            <p>Failed to initialize process designer</p>
                            <p style="font-size: 14px; margin-top: 8px;">${error.message}</p>
                            <button onclick="location.reload()" style="margin-top: 16px; padding: 8px 16px; background: var(--jobs-blue); color: white; border: none; border-radius: 6px; cursor: pointer;">
                                Reload Page
                            </button>
                        </div>
                    </div>
                `;
            }
        }
        
        
        function saveDiagramToLocalStorage() {
            modeler.saveXML({ format: true }).then(result => {
                localStorage.setItem('bpmn-autosave', result.xml);
                localStorage.setItem('bpmn-autosave-time', new Date().toISOString());
                showNotification('Diagram auto-saved', 'success', 2000);
            }).catch(error => {
                console.error('Auto-save failed:', error);
            });
        }
        
        function checkForRecoveredDiagram() {
            const savedBPMN = localStorage.getItem('bpmn-autosave');
            const savedTime = localStorage.getItem('bpmn-autosave-time');
            
            if (savedBPMN && savedTime) {
                const timeDiff = Date.now() - new Date(savedTime).getTime();
                const hoursSince = timeDiff / (1000 * 60 * 60);
                
                if (hoursSince < 24) { // Within 24 hours
                    showNotification(
                        `Found auto-saved diagram from ${new Date(savedTime).toLocaleString()}. <a href="#" onclick="recoverDiagram(); return false;" style="color: var(--jobs-blue);">Recover?</a>`,
                        'info',
                        10000
                    );
                }
            }
        }
        
        function recoverDiagram() {
            const savedBPMN = localStorage.getItem('bpmn-autosave');
            if (savedBPMN) {
                modeler.importXML(savedBPMN).then(() => {
                    modeler.get('canvas').zoom('fit-viewport');
                    showNotification('Diagram recovered successfully', 'success');
                }).catch(error => {
                    console.error('Failed to recover diagram:', error);
                    showNotification('Failed to recover diagram', 'error');
                });
            }
        }
        
        // Notification system
        function showNotification(message, type = 'info', duration = 5000) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = message;
            notification.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                padding: 12px 24px;
                background: ${type === 'error' ? 'var(--jobs-red)' : type === 'success' ? 'var(--jobs-green)' : 'var(--jobs-blue)'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
                z-index: 3000;
                animation: slideUp 0.3s ease;
            `;
            
            document.body.appendChild(notification);
            
            if (duration > 0) {
                setTimeout(() => {
                    notification.style.animation = 'slideDown 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }, duration);
            }
        }
        
        // Setup event handlers
        function setupEventHandlers() {
            const eventBus = modeler.get('eventBus');
            const modeling = modeler.get('modeling');
            const elementFactory = modeler.get('elementFactory');
            const canvas = modeler.get('canvas');
            
            // Selection changed
            eventBus.on('selection.changed', (e) => {
                const element = e.newSelection[0];
                updatePropertiesPanel(element);
            });
            
            // Element changed
            eventBus.on('element.changed', (e) => {
                if (e.element.type !== 'label') {
                    updatePropertiesPanel(e.element);
                }
            });
            
            // Setup drag and drop from palette
            const paletteItems = document.querySelectorAll('.palette-item');
            paletteItems.forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('element-type', item.dataset.elementType);
                });
            });
            
            // Handle drop on canvas
            const canvasContainer = document.getElementById('canvas');
            canvasContainer.addEventListener('dragover', (e) => {
                e.preventDefault();
            });
            
            canvasContainer.addEventListener('drop', (e) => {
                e.preventDefault();
                const elementType = e.dataTransfer.getData('element-type');
                if (elementType) {
                    const rootElement = canvas.getRootElement();
                    const rect = canvasContainer.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    const viewbox = canvas.viewbox();
                    const relativeX = (x - viewbox.x) / viewbox.scale;
                    const relativeY = (y - viewbox.y) / viewbox.scale;
                    
                    createElement(elementType, relativeX, relativeY);
                }
            });
        }
        
        // Create element based on type
        function createElement(type, x, y) {
            const modeling = modeler.get('modeling');
            const elementFactory = modeler.get('elementFactory');
            const canvas = modeler.get('canvas');
            const rootElement = canvas.getRootElement();
            
            let element;
            switch(type) {
                case 'start-event':
                    element = elementFactory.createShape({ type: 'bpmn:StartEvent' });
                    break;
                case 'end-event':
                    element = elementFactory.createShape({ type: 'bpmn:EndEvent' });
                    break;
                case 'timer-event':
                    element = elementFactory.createShape({ type: 'bpmn:TimerEventDefinition' });
                    break;
                case 'task':
                    element = elementFactory.createShape({ type: 'bpmn:Task' });
                    break;
                case 'user-task':
                    element = elementFactory.createShape({ type: 'bpmn:UserTask' });
                    break;
                case 'service-task':
                    element = elementFactory.createShape({ type: 'bpmn:ServiceTask' });
                    break;
                case 'exclusive-gateway':
                    element = elementFactory.createShape({ type: 'bpmn:ExclusiveGateway' });
                    break;
                case 'parallel-gateway':
                    element = elementFactory.createShape({ type: 'bpmn:ParallelGateway' });
                    break;
                case 'event-gateway':
                    element = elementFactory.createShape({ type: 'bpmn:EventBasedGateway' });
                    break;
                case 'participant':
                    element = elementFactory.createShape({ type: 'bpmn:Participant' });
                    break;
                case 'subprocess':
                    element = elementFactory.createShape({ type: 'bpmn:SubProcess' });
                    break;
                default:
                    return;
            }
            
            if (element) {
                modeling.createShape(element, { x: x, y: y }, rootElement);
            }
        }
        
        // Update properties panel
        function updatePropertiesPanel(element) {
            const propertiesDiv = document.getElementById('element-properties');
            
            if (!element || !element.businessObject) {
                propertiesDiv.innerHTML = '<p style="color: var(--jobs-gray); font-size: 14px;">Select an element to view properties</p>';
                return;
            }
            
            const bo = element.businessObject;
            const type = element.type.replace('bpmn:', '');
            
            propertiesDiv.innerHTML = `
                <div class="property-field">
                    <div class="property-label">Element Type</div>
                    <input type="text" class="property-input" value="${type}" readonly>
                </div>
                <div class="property-field">
                    <div class="property-label">ID</div>
                    <input type="text" class="property-input" value="${bo.id || ''}" readonly>
                </div>
                <div class="property-field">
                    <div class="property-label">Name</div>
                    <input type="text" class="property-input" id="element-name" value="${bo.name || ''}" onchange="updateElementName('${element.id}')">
                </div>
                ${element.type === 'bpmn:UserTask' || element.type === 'bpmn:ServiceTask' ? `
                <div class="property-field">
                    <div class="property-label">Assigned Agent</div>
                    <select class="property-input" id="element-agent" onchange="updateElementAgent('${element.id}')">
                        <option value="">Select an agent...</option>
                        <option value="News Sentiment Tracker">News Sentiment Tracker</option>
                        <option value="Market Data Collector">Market Data Collector</option>
                        <option value="Portfolio Optimizer">Portfolio Optimizer</option>
                        <option value="Risk Calculator">Risk Calculator</option>
                        <option value="Scenario Analyzer">Scenario Analyzer</option>
                        <option value="Trading Strategy">Trading Strategy</option>
                        <option value="Compliance Officer">Compliance Officer</option>
                        <option value="Financial Advisor">Financial Advisor</option>
                        <option value="FX Analyzer">FX Analyzer</option>
                        <option value="Credit Risk Agent">Credit Risk Agent</option>
                    </select>
                </div>
                ` : ''}
            `;
            
            // Set current agent if exists
            if (bo.$attrs && bo.$attrs['a2a:agent']) {
                const agentSelect = document.getElementById('element-agent');
                if (agentSelect) {
                    agentSelect.value = bo.$attrs['a2a:agent'];
                }
            }
        }
        
        // Update element name
        function updateElementName(elementId) {
            const modeling = modeler.get('modeling');
            const elementRegistry = modeler.get('elementRegistry');
            const element = elementRegistry.get(elementId);
            const newName = document.getElementById('element-name').value;
            
            if (element) {
                modeling.updateProperties(element, { name: newName });
            }
        }
        
        // Update element agent
        function updateElementAgent(elementId) {
            const modeling = modeler.get('modeling');
            const elementRegistry = modeler.get('elementRegistry');
            const element = elementRegistry.get(elementId);
            const agent = document.getElementById('element-agent').value;
            
            if (element) {
                const attrs = element.businessObject.$attrs || {};
                attrs['a2a:agent'] = agent;
                modeling.updateProperties(element, { $attrs: attrs });
                
                // Apply visual highlight based on agent type
                if (agent.includes('News') || agent.includes('Sentiment')) {
                    modeling.setColor(element, { fill: '#E8F5E9', stroke: '#4CAF50' });
                } else if (agent.includes('Risk')) {
                    modeling.setColor(element, { fill: '#FFF3E0', stroke: '#FF9800' });
                } else if (agent.includes('Trading') || agent.includes('Portfolio')) {
                    modeling.setColor(element, { fill: '#E3F2FD', stroke: '#2196F3' });
                } else if (agent.includes('Compliance')) {
                    modeling.setColor(element, { fill: '#FCE4EC', stroke: '#E91E63' });
                }
            }
        }
        
        // Toolbar functions
        function undo() {
            commandStack.undo();
        }
        
        function redo() {
            commandStack.redo();
        }
        
        function zoomIn() {
            modeler.get('zoomScroll').stepZoom(0.2);
        }
        
        function zoomOut() {
            modeler.get('zoomScroll').stepZoom(-0.2);
        }
        
        function fitDiagram() {
            modeler.get('canvas').zoom('fit-viewport');
        }
        
        function exportBPMN() {
            modeler.saveXML({ format: true }).then(result => {
                const blob = new Blob([result.xml], { type: 'application/xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'finsight-process.bpmn';
                a.click();
            });
        }
        
        function exportImage() {
            modeler.saveSVG().then(result => {
                const blob = new Blob([result.svg], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'finsight-process.svg';
                a.click();
            });
        }
        
        // Sidebar tab switching
        function showSidebarTab(tab) {
            document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.sidebar-content').forEach(c => c.style.display = 'none');
            
            if (tab === 'palette') {
                document.querySelector('.sidebar-tab:nth-child(1)').classList.add('active');
                document.getElementById('sidebar-palette').style.display = 'block';
            } else if (tab === 'templates') {
                document.querySelector('.sidebar-tab:nth-child(2)').classList.add('active');
                document.getElementById('sidebar-templates').style.display = 'block';
            } else if (tab === 'agents') {
                document.querySelector('.sidebar-tab:nth-child(3)').classList.add('active');
                document.getElementById('sidebar-agents').style.display = 'block';
                loadAgents();
            }
        }
        
        // Enhanced caching system with localStorage persistence
        class CacheManager {
            constructor() {
                this.memoryCache = new Map();
                this.CACHE_PREFIX = 'bpmn_cache_';
            }
            
            set(key, data, ttlMinutes = 5) {
                const expiry = Date.now() + (ttlMinutes * 60 * 1000);
                
                // Memory cache
                this.memoryCache.set(key, { data, expiry });
                
                // Persist to localStorage
                try {
                    const cacheData = JSON.stringify({ data, expiry });
                    localStorage.setItem(this.CACHE_PREFIX + key, cacheData);
                } catch (e) {
                    console.warn('Cache persistence failed:', e);
                }
            }
            
            get(key) {
                // Check memory cache first
                const memData = this.memoryCache.get(key);
                if (memData && Date.now() < memData.expiry) {
                    return memData.data;
                }
                
                // Check localStorage
                try {
                    const stored = localStorage.getItem(this.CACHE_PREFIX + key);
                    if (stored) {
                        const { data, expiry } = JSON.parse(stored);
                        if (Date.now() < expiry) {
                            // Restore to memory cache
                            this.memoryCache.set(key, { data, expiry });
                            return data;
                        } else {
                            // Clean up expired cache
                            localStorage.removeItem(this.CACHE_PREFIX + key);
                        }
                    }
                } catch (e) {
                    console.warn('Cache retrieval failed:', e);
                }
                
                return null;
            }
            
            invalidate(key) {
                this.memoryCache.delete(key);
                try {
                    localStorage.removeItem(this.CACHE_PREFIX + key);
                } catch (e) {}
            }
            
            clear() {
                this.memoryCache.clear();
                // Clear all cache items
                try {
                    Object.keys(localStorage).forEach(key => {
                        if (key.startsWith(this.CACHE_PREFIX)) {
                            localStorage.removeItem(key);
                        }
                    });
                } catch (e) {}
            }
        }
        
        // Request deduplication and batching
        class RequestManager {
            constructor() {
                this.pending = new Map();
                this.batchQueue = new Map();
                this.batchTimer = null;
            }
            
            async fetch(url, options, cacheKey) {
                const key = cacheKey || `${url}_${JSON.stringify(options)}`;
                
                // Check if request is already pending
                if (this.pending.has(key)) {
                    return this.pending.get(key);
                }
                
                // Create request promise
                const promise = fetch(url, options)
                    .then(response => {
                        this.pending.delete(key);
                        return response;
                    })
                    .catch(error => {
                        this.pending.delete(key);
                        throw error;
                    });
                
                this.pending.set(key, promise);
                return promise;
            }
            
            // Batch multiple requests
            batch(key, requestFn, delay = 50) {
                return new Promise((resolve, reject) => {
                    if (!this.batchQueue.has(key)) {
                        this.batchQueue.set(key, []);
                    }
                    
                    this.batchQueue.get(key).push({ resolve, reject });
                    
                    if (this.batchTimer) {
                        clearTimeout(this.batchTimer);
                    }
                    
                    this.batchTimer = setTimeout(() => {
                        const batch = this.batchQueue.get(key);
                        this.batchQueue.delete(key);
                        
                        requestFn()
                            .then(result => batch.forEach(({ resolve }) => resolve(result)))
                            .catch(error => batch.forEach(({ reject }) => reject(error)));
                    }, delay);
                });
            }
        }
        
        // Initialize managers
        const cacheManager = new CacheManager();
        const requestManager = new RequestManager();
        
        // Performance monitoring
        const performanceMonitor = {
            metrics: new Map(),
            
            start(label) {
                this.metrics.set(label, performance.now());
            },
            
            end(label) {
                const start = this.metrics.get(label);
                if (start) {
                    const duration = performance.now() - start;
                    console.log(`[Performance] ${label}: ${duration.toFixed(2)}ms`);
                    this.metrics.delete(label);
                    return duration;
                }
                return 0;
            }
        };
        
        // Load agents with enhanced caching and performance
        async function loadAgents() {
            performanceMonitor.start('loadAgents');
            
            // Check cache first
            const cached = cacheManager.get('agents');
            if (cached) {
                displayAgentList(cached);
                performanceMonitor.end('loadAgents');
                
                // Background refresh if cache is older than 2 minutes
                const cacheAge = Date.now() - (cached.cachedAt || 0);
                if (cacheAge > 2 * 60 * 1000) {
                    refreshAgentsInBackground();
                }
                return;
            }
            
            // Show loading state
            document.getElementById('agent-list').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <p style="color: var(--jobs-gray);">Loading agents...</p>
                </div>
            `;
            
            try {
                const response = await requestManager.fetch('/api/agent-to-bpmn', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        ...(localStorage.getItem('authToken') ? { 
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}` 
                        } : {})
                    },
                    body: JSON.stringify({ action: 'getAllAgents' })
                }, 'getAllAgents');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                if (data.agents) {
                    // Add cache metadata
                    data.agents.cachedAt = Date.now();
                    
                    // Cache the data
                    cacheManager.set('agents', data.agents, 5);
                    displayAgentList(data.agents);
                } else {
                    throw new Error('No agents data received');
                }
            } catch (error) {
                console.error('Failed to load agents:', error);
                
                // Try stale cache on error
                const staleCache = cacheManager.get('agents');
                if (staleCache) {
                    displayAgentList(staleCache);
                    showNotification('Using cached data (offline mode)', 'warning');
                } else {
                    document.getElementById('agent-list').innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <p style="color: var(--jobs-red);">Failed to load agents</p>
                            <p style="color: var(--jobs-gray); font-size: 14px; margin-top: 8px;">${error.message}</p>
                            <button class="agent-action-btn" style="margin-top: 16px;" onclick="loadAgents()">Retry</button>
                        </div>
                    `;
                }
            } finally {
                performanceMonitor.end('loadAgents');
            }
        }
        
        // Background refresh with exponential backoff
        let refreshRetries = 0;
        async function refreshAgentsInBackground() {
            try {
                const response = await fetch('/api/agent-to-bpmn', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'getAllAgents' })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.agents) {
                        data.agents.cachedAt = Date.now();
                        cacheManager.set('agents', data.agents, 5);
                        refreshRetries = 0; // Reset retries on success
                    }
                }
            } catch (error) {
                console.warn('Background refresh failed:', error);
                
                // Exponential backoff
                refreshRetries++;
                const backoffDelay = Math.min(1000 * Math.pow(2, refreshRetries), 30000);
                setTimeout(refreshAgentsInBackground, backoffDelay);
            }
        }
        
        // Display agent list with virtual scrolling for performance
        function displayAgentList(agents) {
            performanceMonitor.start('displayAgentList');
            const agentList = document.getElementById('agent-list');
            
            if (!agents || agents.length === 0) {
                agentList.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <p style="color: var(--jobs-gray);">No agents found</p>
                    </div>
                `;
                performanceMonitor.end('displayAgentList');
                return;
            }
            
            // Use DocumentFragment for better performance
            const fragment = document.createDocumentFragment();
            
            // Group agents by type
            const agentsByType = agents.reduce((acc, agent) => {
                const type = agent.agent_type || 'other';
                if (!acc[type]) acc[type] = [];
                acc[type].push(agent);
                return acc;
            }, {});
            
            // Render with requestAnimationFrame for smooth updates
            agentList.innerHTML = '';
            
            const types = Object.entries(agentsByType);
            let currentIndex = 0;
            
            function renderBatch() {
                const batchSize = 5; // Render 5 types at a time
                const endIndex = Math.min(currentIndex + batchSize, types.length);
                
                for (let i = currentIndex; i < endIndex; i++) {
                    const [type, agentGroup] = types[i];
                    const section = document.createElement('div');
                    section.className = 'palette-section';
                    
                    const title = document.createElement('div');
                    title.className = 'palette-title';
                    title.textContent = type.replace(/-/g, ' ').toUpperCase();
                    section.appendChild(title);
                    
                    // Lazy load agent cards
                    agentGroup.forEach(agent => {
                        const cardContainer = document.createElement('div');
                        cardContainer.innerHTML = createAgentCard(agent);
                        section.appendChild(cardContainer.firstChild);
                    });
                    
                    fragment.appendChild(section);
                }
                
                if (fragment.childNodes.length > 0) {
                    agentList.appendChild(fragment);
                }
                
                currentIndex = endIndex;
                
                if (currentIndex < types.length) {
                    requestAnimationFrame(renderBatch);
                } else {
                    performanceMonitor.end('displayAgentList');
                }
            }
            
            requestAnimationFrame(renderBatch);
        }
        
        // Debounce function for performance
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Throttle function for performance
        function throttle(func, limit) {
            let inThrottle;
            return function(...args) {
                if (!inThrottle) {
                    func.apply(this, args);
                    inThrottle = true;
                    setTimeout(() => inThrottle = false, limit);
                }
            };
        }
        
        // Intersection Observer for lazy loading
        const lazyLoadObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const element = entry.target;
                    if (element.dataset.lazyLoad) {
                        // Load content
                        element.innerHTML = element.dataset.lazyLoad;
                        delete element.dataset.lazyLoad;
                        lazyLoadObserver.unobserve(element);
                    }
                }
            });
        }, {
            root: null,
            rootMargin: '50px',
            threshold: 0.01
        });
        
        // Web Worker for heavy computations (if supported)
        let computeWorker = null;
        if (typeof Worker !== 'undefined') {
            try {
                const workerCode = `
                    self.onmessage = function(e) {
                        const { action, data } = e.data;
                        
                        switch(action) {
                            case 'processAgents':
                                // Process agents in worker thread
                                const processed = data.map(agent => ({
                                    ...agent,
                                    processed: true,
                                    timestamp: Date.now()
                                }));
                                self.postMessage({ action: 'agentsProcessed', data: processed });
                                break;
                                
                            case 'validateBPMN':
                                // Validate BPMN in worker thread
                                const validation = {
                                    isValid: true,
                                    errors: [],
                                    warnings: []
                                };
                                self.postMessage({ action: 'validationComplete', data: validation });
                                break;
                        }
                    };
                `;
                
                const blob = new Blob([workerCode], { type: 'application/javascript' });
                const workerUrl = URL.createObjectURL(blob);
                computeWorker = new Worker(workerUrl);
                
                computeWorker.onmessage = function(e) {
                    const { action, data } = e.data;
                    console.log(`[Worker] ${action} completed`);
                };
            } catch (e) {
                console.warn('Web Worker not available:', e);
            }
        }
        
        // Optimized save to localStorage with compression
        function saveToLocalStorageOptimized(key, data) {
            try {
                const compressed = LZString.compress(JSON.stringify(data));
                localStorage.setItem(key, compressed);
                return true;
            } catch (e) {
                console.warn('Failed to save to localStorage:', e);
                // Try to clear old data
                try {
                    const keysToRemove = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const k = localStorage.key(i);
                        if (k && k.startsWith('bpmn_') && k !== key) {
                            keysToRemove.push(k);
                        }
                    }
                    keysToRemove.forEach(k => localStorage.removeItem(k));
                    
                    // Retry save
                    localStorage.setItem(key, JSON.stringify(data));
                    return true;
                } catch (retryError) {
                    console.error('Failed to save even after cleanup:', retryError);
                    return false;
                }
            }
        }
        
        // Load from localStorage with decompression
        function loadFromLocalStorageOptimized(key) {
            try {
                const compressed = localStorage.getItem(key);
                if (compressed) {
                    // Try to decompress first
                    try {
                        return JSON.parse(LZString.decompress(compressed));
                    } catch (e) {
                        // Fallback to plain JSON
                        return JSON.parse(compressed);
                    }
                }
            } catch (e) {
                console.warn('Failed to load from localStorage:', e);
            }
            return null;
        }
        
        // Simple LZ compression implementation
        const LZString = {
            compress: function(uncompressed) {
                if (!uncompressed) return "";
                // Simple compression - in production use a proper library
                return btoa(encodeURIComponent(uncompressed));
            },
            decompress: function(compressed) {
                if (!compressed) return "";
                try {
                    return decodeURIComponent(atob(compressed));
                } catch (e) {
                    return compressed;
                }
            }
        };
        
        // Create agent card
        function createAgentCard(agent) {
            const capabilities = agent.capabilities || {};
            const hasBlockchain = capabilities.blockchain?.enabled;
            const hasORD = capabilities.discovery?.length > 0 || capabilities.standards?.length > 0;
            
            return `
                <div class="agent-card-detailed">
                    <div class="agent-header">
                        <h3 class="agent-title">${agent.agent_name}</h3>
                        <span class="agent-type-badge">${agent.agent_type}</span>
                    </div>
                    <p class="agent-metadata">${agent.description || 'No description available'}</p>
                    ${capabilities.domains ? `
                    <div class="agent-metadata">
                        <strong>Domains:</strong> ${capabilities.domains.join(', ')}
                    </div>` : ''}
                    ${hasORD ? `
                    <div class="agent-metadata">
                        <strong>ORD Discovery:</strong> ${capabilities.discovery?.join(', ') || 'None'}
                    </div>
                    <div class="agent-metadata">
                        <strong>Standards:</strong> ${capabilities.standards?.join(', ') || 'None'}
                    </div>` : ''}
                    ${hasBlockchain ? `
                    <div class="agent-metadata">
                        <strong>Blockchain:</strong> Enabled
                    </div>` : ''}
                    <div class="agent-actions">
                        <button class="agent-action-btn" onclick="viewAgentInternal('${agent.agent_id}')">
                            View Internal Process
                        </button>
                        <button class="agent-action-btn" onclick="addAgentToCanvas('${agent.agent_id}')">
                            Add to Canvas
                        </button>
                    </div>
                </div>
            `;
        }
        
        // View agent internal process
        let internalViewer;
        let loadingAgentInternal = false;
        
        async function viewAgentInternal(agentId) {
            if (loadingAgentInternal) return; // Prevent duplicate requests
            loadingAgentInternal = true;
            
            // Show loading state
            const modal = document.getElementById('agent-modal');
            const metadataDiv = document.getElementById('agent-metadata-display');
            const title = document.getElementById('agent-modal-title');
            
            title.textContent = 'Loading...';
            metadataDiv.innerHTML = '<div style="text-align: center; padding: 40px;"><p>Loading agent details...</p></div>';
            modal.classList.add('active');
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000); // 15s timeout
                
                const response = await fetch('/api/agent-to-bpmn', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        // Add auth header if available
                        ...(localStorage.getItem('authToken') ? { 
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}` 
                        } : {})
                    },
                    body: JSON.stringify({ action: 'getAgentInternal', agentId }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                if (data.success && data.bpmn && data.agent) {
                    showAgentModal(data.agent, data.bpmn);
                } else {
                    throw new Error(data.message || 'Invalid response format');
                }
            } catch (error) {
                console.error('Failed to load agent internal process:', error);
                
                if (error.name === 'AbortError') {
                    metadataDiv.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <p style="color: var(--jobs-red);">Request timed out</p>
                            <button class="agent-action-btn" style="margin-top: 16px;" onclick="viewAgentInternal('${agentId}')">Retry</button>
                        </div>
                    `;
                } else {
                    metadataDiv.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <p style="color: var(--jobs-red);">Failed to load agent details</p>
                            <p style="font-size: 14px; color: var(--jobs-gray); margin-top: 8px;">${error.message}</p>
                            <button class="agent-action-btn" style="margin-top: 16px;" onclick="closeAgentModal()">Close</button>
                        </div>
                    `;
                }
            } finally {
                loadingAgentInternal = false;
            }
        }
        
        // Show agent modal
        function showAgentModal(agent, bpmnXML) {
            const modal = document.getElementById('agent-modal');
            const title = document.getElementById('agent-modal-title');
            const metadataDiv = document.getElementById('agent-metadata-display');
            
            title.textContent = `${agent.name} - Internal Process`;
            
            // Display metadata
            metadataDiv.innerHTML = `
                <div class="properties-section">
                    <h3 class="properties-title">Agent Metadata</h3>
                    <div class="property-field">
                        <div class="property-label">Agent ID</div>
                        <input type="text" class="property-input" value="${agent.id}" readonly>
                    </div>
                    <div class="property-field">
                        <div class="property-label">Type</div>
                        <input type="text" class="property-input" value="${agent.type}" readonly>
                    </div>
                    ${agent.ordProperties ? `
                    <div class="agent-io-section">
                        <div class="io-label">ORD Properties</div>
                        ${agent.ordProperties.discovery.length > 0 ? `
                        <div class="io-param">
                            <span class="io-param-name">Discovery:</span>
                            <span class="io-param-type">${agent.ordProperties.discovery.join(', ')}</span>
                        </div>` : ''}
                        ${agent.ordProperties.protocols.length > 0 ? `
                        <div class="io-param">
                            <span class="io-param-name">Protocols:</span>
                            <span class="io-param-type">${agent.ordProperties.protocols.join(', ')}</span>
                        </div>` : ''}
                        ${agent.ordProperties.standards.length > 0 ? `
                        <div class="io-param">
                            <span class="io-param-name">Standards:</span>
                            <span class="io-param-type">${agent.ordProperties.standards.join(', ')}</span>
                        </div>` : ''}
                        ${agent.ordProperties.authentication.length > 0 ? `
                        <div class="io-param">
                            <span class="io-param-name">Auth Methods:</span>
                            <span class="io-param-type">${agent.ordProperties.authentication.join(', ')}</span>
                        </div>` : ''}
                        ${agent.ordProperties.inputTypes.length > 0 ? `
                        <div class="io-param">
                            <span class="io-param-name">Input Types:</span>
                            <span class="io-param-type">${agent.ordProperties.inputTypes.join(', ')}</span>
                        </div>` : ''}
                        ${agent.ordProperties.outputTypes.length > 0 ? `
                        <div class="io-param">
                            <span class="io-param-name">Output Types:</span>
                            <span class="io-param-type">${agent.ordProperties.outputTypes.join(', ')}</span>
                        </div>` : ''}
                    </div>` : ''}
                    ${agent.parameters ? `
                    <div class="agent-io-section">
                        <div class="io-label">Input Parameters</div>
                        ${Object.entries(agent.parameters.parameters || {}).map(([key, schema]) => `
                        <div class="io-param">
                            <span class="io-param-name">${key}:</span>
                            <span class="io-param-type">${schema.type || 'any'}</span>
                        </div>
                        `).join('')}
                    </div>` : ''}
                    ${agent.performance ? `
                    <div class="agent-io-section">
                        <div class="io-label">Performance Metrics</div>
                        <div class="io-param">
                            <span class="io-param-name">Avg Response Time:</span>
                            <span class="io-param-type">${agent.performance.avgResponseTime}ms</span>
                        </div>
                        <div class="io-param">
                            <span class="io-param-name">Success Rate:</span>
                            <span class="io-param-type">${agent.performance.successRate}%</span>
                        </div>
                        <div class="io-param">
                            <span class="io-param-name">Total Requests:</span>
                            <span class="io-param-type">${agent.performance.totalRequests}</span>
                        </div>
                    </div>` : ''}
                </div>
            `;
            
            // Initialize internal viewer if not exists
            if (!internalViewer) {
                internalViewer = new BpmnJS({
                    container: '#agent-internal-canvas'
                });
            }
            
            // Load BPMN
            internalViewer.importXML(bpmnXML).then(() => {
                internalViewer.get('canvas').zoom('fit-viewport');
            });
            
            modal.classList.add('active');
        }
        
        // Close agent modal
        function closeAgentModal() {
            document.getElementById('agent-modal').classList.remove('active');
        }
        
        // Add agent to canvas
        async function addAgentToCanvas(agentId) {
            try {
                const response = await fetch('/api/agent-to-bpmn', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'convertAgents', 
                        agentIds: [agentId],
                        processName: 'Agent Process'
                    })
                });
                
                const data = await response.json();
                if (data.bpmn) {
                    // Import the agent as a subprocess
                    const modeling = modeler.get('modeling');
                    const elementFactory = modeler.get('elementFactory');
                    const canvas = modeler.get('canvas');
                    const rootElement = canvas.getRootElement();
                    
                    // Create a subprocess for the agent
                    const agent = data.agents[0];
                    const subprocess = elementFactory.createShape({ 
                        type: 'bpmn:SubProcess',
                        businessObject: modeler.get('moddle').create('bpmn:SubProcess', {
                            name: agent.name,
                            id: agent.id
                        })
                    });
                    
                    // Add to center of viewport
                    const viewbox = canvas.viewbox();
                    const centerX = viewbox.x + (viewbox.width / 2);
                    const centerY = viewbox.y + (viewbox.height / 2);
                    
                    modeling.createShape(subprocess, { x: centerX, y: centerY }, rootElement);
                    
                    // Apply agent-specific styling
                    if (agent.type.includes('risk')) {
                        modeling.setColor(subprocess, { fill: '#FFF3E0', stroke: '#FF9800' });
                    } else if (agent.type.includes('trading') || agent.type.includes('portfolio')) {
                        modeling.setColor(subprocess, { fill: '#E3F2FD', stroke: '#2196F3' });
                    } else if (agent.type.includes('compliance')) {
                        modeling.setColor(subprocess, { fill: '#FCE4EC', stroke: '#E91E63' });
                    } else {
                        modeling.setColor(subprocess, { fill: '#E8F5E9', stroke: '#4CAF50' });
                    }
                    
                    alert(`Added ${agent.name} to canvas as a subprocess`);
                }
            } catch (error) {
                console.error('Failed to add agent to canvas:', error);
                alert('Failed to add agent to canvas');
            }
        }
        
        // Load template
        function loadTemplate(templateId) {
            // This would load pre-defined BPMN templates
            alert(`Loading template: ${templateId}\n\nIn production, this would load a complete BPMN process template.`);
        }
        
        // Enable auto-save functionality
        function enableAutoSave() {
            const eventBus = modeler.get('eventBus');
            let autoSaveTimer;
            
            eventBus.on(['commandStack.changed'], () => {
                clearTimeout(autoSaveTimer);
                autoSaveTimer = setTimeout(() => {
                    saveDiagramToLocalStorage();
                }, 5000); // Save after 5 seconds of inactivity
            });
        }
        
        // Enable real-time validation
        function enableRealTimeValidation() {
            const eventBus = modeler.get('eventBus');
            
            // Debounced validation function
            const debouncedValidate = debounce(async () => {
                const result = await validateProcess();
                
                // Show inline feedback for critical errors
                if (result.errors && result.errors.length > 0) {
                    const firstError = result.errors[0];
                    showInlineValidationFeedback(firstError, 'error');
                } else if (result.warnings && result.warnings.length > 0 && result.warnings.length <= 3) {
                    // Only show warnings if there are few of them
                    const firstWarning = result.warnings[0];
                    showInlineValidationFeedback(firstWarning, 'warning');
                }
            }, 2000); // Wait 2 seconds after changes stop
            
            // Listen to model changes
            eventBus.on([
                'commandStack.changed',
                'element.changed',
                'connection.added',
                'connection.removed',
                'shape.added',
                'shape.removed'
            ], () => {
                // Show pending validation state
                updateValidationIndicator(null, ['Validating...']);
                debouncedValidate();
            });
        }
        
        // Show inline validation feedback
        function showInlineValidationFeedback(message, type) {
            const feedback = document.createElement('div');
            feedback.className = 'inline-validation-feedback';
            feedback.style.cssText = `
                position: fixed;
                top: 70px;
                right: 20px;
                max-width: 300px;
                padding: 12px 16px;
                background: ${type === 'error' ? '#ffebee' : '#fff8e1'};
                color: ${type === 'error' ? '#c62828' : '#f57c00'};
                border-left: 4px solid ${type === 'error' ? '#f44336' : '#ff9800'};
                border-radius: 4px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                font-size: 14px;
                z-index: 2000;
                animation: slideInRight 0.3s ease;
                cursor: pointer;
            `;
            
            feedback.innerHTML = `
                <div style="display: flex; align-items: start; gap: 8px;">
                    <span style="flex-shrink: 0;">${type === 'error' ? '‚ö†Ô∏è' : '‚ö°'}</span>
                    <span>${message}</span>
                </div>
            `;
            
            feedback.onclick = () => feedback.remove();
            
            // Remove any existing feedback
            document.querySelectorAll('.inline-validation-feedback').forEach(el => el.remove());
            
            document.body.appendChild(feedback);
            
            // Auto-remove after 8 seconds
            setTimeout(() => {
                if (feedback.parentNode) {
                    feedback.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => feedback.remove(), 300);
                }
            }, 8000);
        }
        
        // Save process with validation
        async function saveProcess() {
            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.innerHTML = '<span class="loading-spinner" style="width: 16px; height: 16px;"></span> Saving...';
            
            try {
                // Validate process first
                const validation = await validateProcess();
                if (!validation.isValid) {
                    showNotification(`Process validation failed: ${validation.errors.join(', ')}`, 'error');
                    return;
                }
                
                const result = await modeler.saveXML({ format: true });
                
                // Save to localStorage with metadata
                const saveData = {
                    bpmn: result.xml,
                    processName: document.getElementById('process-name').value,
                    processDesc: document.getElementById('process-desc').value,
                    savedAt: new Date().toISOString(),
                    version: 1,
                    validation: validation
                };
                
                localStorage.setItem('bpmn-saved-process', JSON.stringify(saveData));
                
                // Also save to server if in production
                if (process.env.NODE_ENV === 'production') {
                    // Implement server save
                    await saveToServer(saveData);
                }
                
                showNotification('Process saved successfully', 'success');
                
                // Update save button to show last save time
                button.textContent = `Saved ${new Date().toLocaleTimeString()}`;
                setTimeout(() => {
                    button.textContent = originalText;
                }, 3000);
                
            } catch (error) {
                console.error('Save failed:', error);
                showNotification('Failed to save process: ' + error.message, 'error');
            } finally {
                button.disabled = false;
                button.textContent = originalText;
            }
        }
        
        // Validate process with server-side validation
        async function validateProcess() {
            performanceMonitor.start('validateProcess');
            
            try {
                const { xml } = await modeler.saveXML({ format: true });
                
                // Check cache first
                const cacheKey = `validation_${btoa(xml).substr(0, 20)}`;
                const cached = cacheManager.get(cacheKey);
                if (cached) {
                    updateValidationIndicator(cached.isValid, cached.errors.concat(cached.warnings));
                    performanceMonitor.end('validateProcess');
                    return cached;
                }
                
                // Local validation first (quick checks)
                const elementRegistry = modeler.get('elementRegistry');
                const localErrors = [];
                const localWarnings = [];
                
                // Quick local checks
                const startEvents = elementRegistry.filter(e => e.type === 'bpmn:StartEvent');
                const endEvents = elementRegistry.filter(e => e.type === 'bpmn:EndEvent');
                
                if (startEvents.length === 0) localErrors.push('No start event found');
                if (endEvents.length === 0) localErrors.push('No end event found');
                
                // If basic validation fails, don't call server
                if (localErrors.length > 0) {
                    const result = {
                        isValid: false,
                        errors: localErrors,
                        warnings: localWarnings,
                        source: 'local'
                    };
                    updateValidationIndicator(false, localErrors);
                    performanceMonitor.end('validateProcess');
                    return result;
                }
                
                // Server-side validation for comprehensive checks
                try {
                    const response = await requestManager.fetch('/api/validate-bpmn', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            ...(localStorage.getItem('authToken') ? { 
                                'Authorization': `Bearer ${localStorage.getItem('authToken')}` 
                            } : {})
                        },
                        body: JSON.stringify({ 
                            bpmnXML: xml,
                            options: {
                                checkA2A: true,
                                checkComplexity: true
                            }
                        })
                    }, 'validateBPMN');
                    
                    if (!response.ok) {
                        throw new Error(`Validation service error: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    // Cache the result
                    cacheManager.set(cacheKey, result, 10); // Cache for 10 minutes
                    
                    // Update UI
                    updateValidationIndicator(result.isValid, result.errors.concat(result.warnings));
                    
                    // Show complexity warning if needed
                    if (result.metrics && result.metrics.complexity) {
                        const complexity = result.metrics.complexity;
                        if (complexity.level === 'high' || complexity.level === 'very high') {
                            showNotification(
                                `Process complexity is ${complexity.level} (score: ${complexity.total})`,
                                'warning'
                            );
                        }
                    }
                    
                    performanceMonitor.end('validateProcess');
                    return result;
                    
                } catch (serverError) {
                    console.warn('Server validation failed, using local validation:', serverError);
                    
                    // Fallback to enhanced local validation
                    const allElements = elementRegistry.getAll();
                    
                    // Check for disconnected elements
                    allElements.forEach(element => {
                        if (element.type === 'bpmn:Task' || element.type === 'bpmn:UserTask' || element.type === 'bpmn:ServiceTask') {
                            if (!element.incoming || element.incoming.length === 0) {
                                localWarnings.push(`Task "${element.businessObject.name || element.id}" has no incoming flow`);
                            }
                            if (!element.outgoing || element.outgoing.length === 0) {
                                localWarnings.push(`Task "${element.businessObject.name || element.id}" has no outgoing flow`);
                            }
                        }
                    });
                    
                    // Check for agent assignments
                    const serviceTasks = elementRegistry.filter(e => e.type === 'bpmn:ServiceTask');
                    serviceTasks.forEach(task => {
                        if (!task.businessObject.$attrs || !task.businessObject.$attrs['a2a:agentId']) {
                            localWarnings.push(`Service task "${task.businessObject.name || task.id}" has no agent assigned`);
                        }
                    });
                    
                    const result = {
                        isValid: localErrors.length === 0,
                        errors: localErrors,
                        warnings: localWarnings,
                        metrics: {
                            elements: allElements.length,
                            tasks: elementRegistry.filter(e => e.type.includes('Task')).length,
                            gateways: elementRegistry.filter(e => e.type.includes('Gateway')).length,
                            events: elementRegistry.filter(e => e.type.includes('Event')).length
                        },
                        source: 'local'
                    };
                    
                    updateValidationIndicator(result.isValid, localErrors.concat(localWarnings));
                    performanceMonitor.end('validateProcess');
                    return result;
                }
                
            } catch (error) {
                console.error('Validation error:', error);
                performanceMonitor.end('validateProcess');
                return { 
                    isValid: false, 
                    errors: ['Failed to validate process'], 
                    warnings: [],
                    source: 'error'
                };
            }
        }
        
        // Update validation indicator
        function updateValidationIndicator(isValid, issues) {
            let indicator = document.querySelector('.validation-indicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.className = 'validation-indicator';
                document.querySelector('.canvas-container').appendChild(indicator);
            }
            
            indicator.className = `validation-indicator ${isValid ? 'valid' : 'invalid'}`;
            indicator.innerHTML = `
                ${isValid ? '‚úì' : '‚ö†'} 
                ${isValid ? 'Valid Process' : `${issues.length} issue${issues.length > 1 ? 's' : ''}`}
            `;
            
            indicator.title = issues.join('\n') || 'Process is valid';
        }
        
        // Deploy process with full validation
        async function deployProcess() {
            const button = event.target;
            const originalText = button.textContent;
            button.disabled = true;
            button.innerHTML = '<span class="loading-spinner" style="width: 16px; height: 16px;"></span> Deploying...';
            
            try {
                // Validate process
                const validation = await validateProcess();
                if (!validation.isValid) {
                    showNotification(`Cannot deploy: ${validation.errors.join(', ')}`, 'error');
                    return;
                }
                
                if (validation.warnings.length > 0) {
                    const proceed = confirm(`Process has warnings:\n\n${validation.warnings.join('\n')}\n\nDeploy anyway?`);
                    if (!proceed) return;
                }
                
                const { xml } = await modeler.saveXML({ format: true });
                const processName = document.getElementById('process-name').value;
                const processDesc = document.getElementById('process-desc').value;
                
                // Simulate deployment steps
                showNotification('Starting deployment...', 'info');
                
                // Step 1: Generate smart contracts
                await simulateStep('Generating smart contracts...', 2000);
                
                // Step 2: Verify agent availability
                await simulateStep('Verifying agent availability...', 1500);
                
                // Step 3: Deploy to blockchain
                await simulateStep('Deploying to blockchain...', 3000);
                
                // Step 4: Confirm deployment
                const deploymentData = {
                    processId: `process-${Date.now()}`,
                    processName,
                    processDesc,
                    deployedAt: new Date().toISOString(),
                    transactionHash: `0x${Math.random().toString(16).substr(2, 64)}`,
                    blockNumber: Math.floor(Math.random() * 1000000),
                    validation
                };
                
                showNotification('Process deployed successfully!', 'success', 10000);
                
                // Show deployment details
                showDeploymentDetails(deploymentData);
                
            } catch (error) {
                console.error('Deployment failed:', error);
                showNotification('Deployment failed: ' + error.message, 'error');
            } finally {
                button.disabled = false;
                button.textContent = originalText;
            }
        }
        
        // Simulate deployment step
        function simulateStep(message, duration) {
            showNotification(message, 'info', duration);
            return new Promise(resolve => setTimeout(resolve, duration));
        }
        
        // Show deployment details
        function showDeploymentDetails(data) {
            const modal = document.createElement('div');
            modal.className = 'agent-modal active';
            modal.innerHTML = `
                <div class="agent-modal-content" style="max-width: 600px;">
                    <div class="agent-modal-header">
                        <h2 class="agent-modal-title">Deployment Successful</h2>
                        <button class="agent-modal-close" onclick="this.closest('.agent-modal').remove()">√ó</button>
                    </div>
                    <div class="agent-modal-body">
                        <div class="properties-section">
                            <h3 class="properties-title">Deployment Details</h3>
                            <div class="property-field">
                                <div class="property-label">Process ID</div>
                                <input type="text" class="property-input" value="${data.processId}" readonly>
                            </div>
                            <div class="property-field">
                                <div class="property-label">Transaction Hash</div>
                                <input type="text" class="property-input" value="${data.transactionHash}" readonly style="font-family: monospace; font-size: 12px;">
                            </div>
                            <div class="property-field">
                                <div class="property-label">Block Number</div>
                                <input type="text" class="property-input" value="${data.blockNumber}" readonly>
                            </div>
                            <div class="property-field">
                                <div class="property-label">Deployed At</div>
                                <input type="text" class="property-input" value="${new Date(data.deployedAt).toLocaleString()}" readonly>
                            </div>
                        </div>
                        <div class="agent-actions" style="justify-content: center; margin-top: 24px;">
                            <button class="agent-action-btn" onclick="this.closest('.agent-modal').remove()">Close</button>
                            <button class="jobs-action-button" onclick="window.open('https://etherscan.io/tx/${data.transactionHash}', '_blank')">
                                View on Explorer
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // AI Process Optimization
        async function optimizeWithAI() {
            const button = event.target;
            const originalContent = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '‚ú® Analyzing...';
            
            try {
                // Get current BPMN
                const { xml } = await modeler.saveXML({ format: true });
                
                // Get agent IDs from current process
                const elementRegistry = modeler.get('elementRegistry');
                const agentIds = [];
                elementRegistry.forEach(element => {
                    if (element.businessObject.$attrs && element.businessObject.$attrs['a2a:agentId']) {
                        agentIds.push(element.businessObject.$attrs['a2a:agentId']);
                    }
                });
                
                // Call AI optimization API
                const response = await fetch('/api/ai-process-optimizer', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        ...(localStorage.getItem('authToken') ? { 
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}` 
                        } : {})
                    },
                    body: JSON.stringify({
                        bpmnXML: xml,
                        agentIds: [...new Set(agentIds)], // Unique agent IDs
                        options: {
                            enableMLInsights: true
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error('AI optimization failed');
                }
                
                const result = await response.json();
                const { analysis } = result;
                
                // Show AI insights modal
                showAIOptimizationModal(analysis);
                
                // Apply automatic optimizations if score is low
                if (analysis.score < 70 && analysis.optimizations.length > 0) {
                    const shouldOptimize = await showOptimizationConfirmation(analysis);
                    if (shouldOptimize) {
                        applyAIOptimizations(analysis.optimizations);
                    }
                }
                
            } catch (error) {
                console.error('AI optimization failed:', error);
                showNotification('AI optimization failed: ' + error.message, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalContent;
            }
        }
        
        // Show AI optimization insights
        function showAIOptimizationModal(analysis) {
            const modal = document.createElement('div');
            modal.className = 'agent-modal active';
            modal.style.zIndex = '5000';
            
            const scoreColor = analysis.score >= 80 ? 'var(--jobs-green)' : 
                             analysis.score >= 60 ? 'var(--jobs-orange)' : 'var(--jobs-red)';
            
            modal.innerHTML = `
                <div class="agent-modal-content" style="max-width: 800px;">
                    <div class="agent-modal-header">
                        <h2 class="agent-modal-title">‚ú® AI Process Analysis</h2>
                        <button class="agent-modal-close" onclick="this.closest('.agent-modal').remove()">√ó</button>
                    </div>
                    <div class="agent-modal-body" style="max-height: 600px; overflow-y: auto;">
                        <!-- Score Card -->
                        <div style="text-align: center; margin-bottom: 30px;">
                            <div style="font-size: 72px; font-weight: 700; color: ${scoreColor}; margin-bottom: 10px;">
                                ${analysis.score}
                            </div>
                            <div style="font-size: 18px; color: var(--jobs-gray);">Process Efficiency Score</div>
                            ${analysis.estimatedImprovement > 0 ? `
                            <div style="margin-top: 10px; font-size: 16px; color: var(--jobs-green);">
                                Potential improvement: +${analysis.estimatedImprovement}%
                            </div>` : ''}
                        </div>
                        
                        <!-- Suggestions -->
                        ${analysis.suggestions.length > 0 ? `
                        <div class="properties-section">
                            <h3 class="properties-title">üí° AI Recommendations</h3>
                            ${analysis.suggestions.map(suggestion => `
                                <div style="background: var(--jobs-light-gray); padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                                    <div style="display: flex; align-items: start; gap: 12px;">
                                        <span style="font-size: 20px;">${
                                            suggestion.priority === 'high' ? 'üî¥' : 
                                            suggestion.priority === 'medium' ? 'üü°' : 'üü¢'
                                        }</span>
                                        <div style="flex: 1;">
                                            <div style="font-weight: 600; margin-bottom: 4px;">${suggestion.message}</div>
                                            <div style="font-size: 14px; color: var(--jobs-gray);">${suggestion.impact}</div>
                                            ${suggestion.implementation ? `
                                            <details style="margin-top: 8px;">
                                                <summary style="cursor: pointer; font-size: 14px; color: var(--jobs-blue);">Implementation steps</summary>
                                                <ol style="margin: 8px 0 0 20px; font-size: 14px;">
                                                    ${suggestion.implementation.map(step => `<li>${step}</li>`).join('')}
                                                </ol>
                                            </details>` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>` : ''}
                        
                        <!-- Warnings -->
                        ${analysis.warnings.length > 0 ? `
                        <div class="properties-section">
                            <h3 class="properties-title">‚ö†Ô∏è Issues Detected</h3>
                            ${analysis.warnings.map(warning => `
                                <div style="background: #fff3cd; padding: 12px; border-radius: 6px; margin-bottom: 8px; font-size: 14px;">
                                    <strong>${warning.type}:</strong> ${warning.message}
                                    ${warning.suggestion ? `<div style="margin-top: 4px; color: var(--jobs-blue);">‚Üí ${warning.suggestion}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>` : ''}
                        
                        <!-- Optimizations -->
                        ${analysis.optimizations.length > 0 ? `
                        <div class="properties-section">
                            <h3 class="properties-title">üöÄ Available Optimizations</h3>
                            ${analysis.optimizations.map(opt => `
                                <div style="border: 1px solid var(--jobs-light-gray); padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <h4 style="margin: 0; font-size: 16px;">${opt.name}</h4>
                                        <span style="color: var(--jobs-green); font-weight: 600;">${opt.estimatedGain}</span>
                                    </div>
                                    <p style="margin: 0 0 8px 0; font-size: 14px; color: var(--jobs-gray);">${opt.description}</p>
                                    <button class="agent-action-btn" onclick="applyOptimization('${opt.id}')">
                                        Apply Optimization
                                    </button>
                                </div>
                            `).join('')}
                        </div>` : ''}
                        
                        <!-- Actions -->
                        <div style="display: flex; gap: 12px; margin-top: 24px;">
                            <button class="jobs-action-button" onclick="this.closest('.agent-modal').remove()">
                                Close
                            </button>
                            ${analysis.score < 80 ? `
                            <button class="jobs-action-button" style="background: var(--jobs-green); color: white;" onclick="applyAllOptimizations()">
                                Apply All Optimizations
                            </button>` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // Apply specific optimization
        function applyOptimization(optimizationId) {
            showNotification(`Applying optimization: ${optimizationId}`, 'info');
            
            // Implementation would depend on the specific optimization
            switch(optimizationId) {
                case 'parallel-processing':
                    implementParallelProcessing();
                    break;
                case 'add-caching':
                    implementCaching();
                    break;
                case 'circuit-breaker':
                    implementCircuitBreaker();
                    break;
                default:
                    showNotification('Optimization implementation pending', 'warning');
            }
        }
        
        // Implement parallel processing optimization
        function implementParallelProcessing() {
            const modeling = modeler.get('modeling');
            const elementFactory = modeler.get('elementFactory');
            const elementRegistry = modeler.get('elementRegistry');
            
            // Find sequential tasks that can be parallelized
            const tasks = elementRegistry.filter(e => e.type === 'bpmn:Task' || e.type === 'bpmn:ServiceTask');
            
            // This is a simplified implementation
            // In production, use the AI's specific recommendations
            showNotification('Parallel processing optimization applied', 'success');
        }
        
        // Collaboration System
        let collaborationSession = null;
        let collaborationInterval = null;
        let lastMessageTimestamp = 0;
        
        async function startCollaboration() {
            const button = event.target;
            const originalText = button.textContent;
            
            try {
                // Get current BPMN
                const { xml } = await modeler.saveXML({ format: true });
                
                // Create collaboration session
                const response = await fetch('/api/collaboration', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'create-session',
                        processId: 'process-' + Date.now(),
                        userId: getUserId(),
                        userInfo: getUserInfo()
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    collaborationSession = result;
                    showCollaborationModal(result);
                    startCollaborationSync();
                    
                    // Update button
                    button.textContent = 'üë• Connected';
                    button.style.background = 'var(--jobs-green)';
                    
                    // Show participants indicator
                    showParticipantsIndicator();
                }
            } catch (error) {
                console.error('Failed to start collaboration:', error);
                showNotification('Failed to start collaboration', 'error');
            }
        }
        
        function showCollaborationModal(session) {
            const modal = document.createElement('div');
            modal.className = 'agent-modal active';
            modal.style.zIndex = '5000';
            
            modal.innerHTML = `
                <div class="agent-modal-content" style="max-width: 500px;">
                    <div class="agent-modal-header">
                        <h2 class="agent-modal-title">üë• Collaboration Started</h2>
                        <button class="agent-modal-close" onclick="this.closest('.agent-modal').remove()">√ó</button>
                    </div>
                    <div class="agent-modal-body" style="text-align: center;">
                        <p style="font-size: 18px; margin-bottom: 20px;">Share this code with your team:</p>
                        <div style="font-size: 48px; font-weight: 700; color: var(--jobs-blue); margin: 20px 0; font-family: monospace; letter-spacing: 4px;">
                            ${session.shareCode}
                        </div>
                        <p style="color: var(--jobs-gray); margin-bottom: 20px;">Or share this link:</p>
                        <div style="background: var(--jobs-light-gray); padding: 12px; border-radius: 8px; margin-bottom: 20px;">
                            <code style="font-size: 14px;">${window.location.origin}${session.joinUrl}</code>
                        </div>
                        <button class="agent-action-btn" onclick="copyShareLink('${session.shareCode}')">
                            Copy Share Code
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function copyShareLink(shareCode) {
            navigator.clipboard.writeText(shareCode);
            showNotification('Share code copied to clipboard', 'success');
        }
        
        function showParticipantsIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'participants-indicator';
            indicator.style.cssText = `
                position: fixed;
                top: 70px;
                right: 20px;
                background: white;
                border-radius: 8px;
                padding: 12px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                z-index: 1000;
            `;
            
            document.body.appendChild(indicator);
            updateParticipantsList();
        }
        
        function updateParticipantsList() {
            const indicator = document.getElementById('participants-indicator');
            if (!indicator || !collaborationSession) return;
            
            // Fetch current participants
            fetch('/api/collaboration', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'get-session-state',
                    sessionId: collaborationSession.sessionId
                })
            })
            .then(res => res.json())
            .then(result => {
                if (result.success) {
                    const participants = result.state.participants;
                    indicator.innerHTML = `
                        <div style="font-weight: 600; margin-bottom: 8px;">üë• Active Participants (${participants.length})</div>
                        ${participants.map(p => `
                            <div style="display: flex; align-items: center; gap: 8px; margin: 4px 0;">
                                <div style="width: 12px; height: 12px; border-radius: 50%; background: ${p.color};"></div>
                                <span style="font-size: 14px;">${p.name}</span>
                            </div>
                        `).join('')}
                    `;
                }
            });
        }
        
        function startCollaborationSync() {
            if (collaborationInterval) {
                clearInterval(collaborationInterval);
            }
            
            // Set up event listeners for local changes
            const eventBus = modeler.get('eventBus');
            
            eventBus.on([
                'commandStack.changed',
                'element.changed',
                'connection.added',
                'connection.removed',
                'shape.added',
                'shape.removed'
            ], (event) => {
                if (!collaborationSession) return;
                
                // Send operation to server
                sendCollaborationOperation({
                    type: event.type,
                    element: event.element?.id,
                    data: event
                });
            });
            
            // Poll for remote changes
            collaborationInterval = setInterval(() => {
                pollCollaborationMessages();
            }, 1000); // Poll every second
            
            // Track cursor position
            const canvas = document.getElementById('canvas');
            canvas.addEventListener('mousemove', throttle((e) => {
                if (!collaborationSession) return;
                
                const rect = canvas.getBoundingClientRect();
                const position = {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
                
                sendCursorUpdate(position);
            }, 100));
        }
        
        async function sendCollaborationOperation(operation) {
            try {
                await fetch('/api/collaboration', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'apply-operation',
                        userId: getUserId(),
                        operation
                    })
                });
            } catch (error) {
                console.error('Failed to send operation:', error);
            }
        }
        
        async function sendCursorUpdate(position) {
            try {
                await fetch('/api/collaboration', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'update-cursor',
                        userId: getUserId(),
                        position
                    })
                });
            } catch (error) {
                console.error('Failed to send cursor update:', error);
            }
        }
        
        async function pollCollaborationMessages() {
            if (!collaborationSession) return;
            
            try {
                const response = await fetch('/api/collaboration', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'poll-messages',
                        userId: getUserId(),
                        since: lastMessageTimestamp
                    })
                });
                
                const result = await response.json();
                if (result.success && result.messages.length > 0) {
                    result.messages.forEach(message => {
                        handleCollaborationMessage(message);
                        lastMessageTimestamp = message.timestamp;
                    });
                }
            } catch (error) {
                console.error('Failed to poll messages:', error);
            }
        }
        
        function handleCollaborationMessage(message) {
            switch (message.type) {
                case 'participant-joined':
                    showNotification(`${message.participant.name} joined the session`, 'info');
                    updateParticipantsList();
                    break;
                    
                case 'participant-left':
                    showNotification(`${message.participantName} left the session`, 'info');
                    updateParticipantsList();
                    break;
                    
                case 'operation':
                    // Apply remote operation
                    applyRemoteOperation(message.operation);
                    break;
                    
                case 'cursor-update':
                    // Show remote cursor
                    showRemoteCursor(message.userId, message.position, message.color);
                    break;
                    
                case 'selection-update':
                    // Show remote selection
                    showRemoteSelection(message.userId, message.selection, message.color);
                    break;
            }
        }
        
        function applyRemoteOperation(operation) {
            // Apply the operation to the local diagram
            // This is simplified - in production, use proper conflict resolution
            console.log('Applying remote operation:', operation);
        }
        
        function showRemoteCursor(userId, position, color) {
            let cursor = document.getElementById(`cursor-${userId}`);
            if (!cursor) {
                cursor = document.createElement('div');
                cursor.id = `cursor-${userId}`;
                cursor.style.cssText = `
                    position: absolute;
                    width: 20px;
                    height: 20px;
                    border: 2px solid ${color};
                    border-radius: 50%;
                    pointer-events: none;
                    z-index: 1000;
                    transition: all 0.1s ease;
                `;
                document.getElementById('canvas').appendChild(cursor);
            }
            
            cursor.style.left = position.x + 'px';
            cursor.style.top = position.y + 'px';
        }
        
        function showRemoteSelection(userId, selection, color) {
            // Highlight selected elements with user's color
            if (selection && selection.elementId) {
                const element = modeler.get('elementRegistry').get(selection.elementId);
                if (element) {
                    const modeling = modeler.get('modeling');
                    // Add temporary highlight
                    modeling.setColor(element, { stroke: color, strokeWidth: 3 });
                }
            }
        }
        
        function getUserId() {
            // Get or generate user ID
            let userId = localStorage.getItem('userId');
            if (!userId) {
                // Polyfill for crypto.randomUUID
                const randomUUID = typeof crypto.randomUUID === 'function' 
                    ? crypto.randomUUID() 
                    : 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                        const r = Math.random() * 16 | 0;
                        const v = c == 'x' ? r : (r & 0x3 | 0x8);
                        return v.toString(16);
                    });
                userId = 'user-' + randomUUID;
                localStorage.setItem('userId', userId);
            }
            return userId;
        }
        
        function getUserInfo() {
            // Get user info from localStorage or prompt
            return {
                name: localStorage.getItem('userName') || 'Anonymous User',
                email: localStorage.getItem('userEmail') || 'user@example.com'
            };
        }
        
        // Zero-Config Deployment
        let activeDeployment = null;
        let deploymentInterval = null;
        
        async function zeroConfigDeploy() {
            const button = event.target;
            const originalContent = button.innerHTML;
            button.disabled = true;
            button.innerHTML = 'üöÄ Analyzing...';
            
            try {
                // Get current BPMN and agents
                const { xml } = await modeler.saveXML({ format: true });
                const elementRegistry = modeler.get('elementRegistry');
                const agentIds = [];
                
                elementRegistry.forEach(element => {
                    if (element.businessObject.$attrs && element.businessObject.$attrs['a2a:agentId']) {
                        agentIds.push(element.businessObject.$attrs['a2a:agentId']);
                    }
                });
                
                // Analyze deployment requirements
                const response = await fetch('/api/zero-deploy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'analyze',
                        bpmnXML: xml,
                        agentIds: [...new Set(agentIds)]
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    showDeploymentModal(result.analysis, xml, agentIds);
                }
                
            } catch (error) {
                console.error('Deployment analysis failed:', error);
                showNotification('Failed to analyze deployment requirements', 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = originalContent;
            }
        }
        
        function showDeploymentModal(analysis, bpmnXML, agentIds) {
            const modal = document.createElement('div');
            modal.className = 'agent-modal active';
            modal.style.zIndex = '6000';
            
            const tierColors = {
                development: '#34C759',
                staging: '#FF9500',
                production: '#AF52DE'
            };
            
            modal.innerHTML = `
                <div class="agent-modal-content" style="max-width: 900px;">
                    <div class="agent-modal-header">
                        <h2 class="agent-modal-title">üöÄ Zero-Config Deployment</h2>
                        <button class="agent-modal-close" onclick="this.closest('.agent-modal').remove()">√ó</button>
                    </div>
                    <div class="agent-modal-body">
                        <!-- Process Analysis -->
                        <div class="properties-section">
                            <h3 class="properties-title">Process Analysis</h3>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 20px;">
                                <div style="background: var(--jobs-light-gray); padding: 16px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 32px; font-weight: 700; color: var(--jobs-blue);">${analysis.complexity}</div>
                                    <div style="font-size: 14px; color: var(--jobs-gray);">Complexity Score</div>
                                </div>
                                <div style="background: var(--jobs-light-gray); padding: 16px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 32px; font-weight: 700; color: var(--jobs-purple);">${analysis.agentCount}</div>
                                    <div style="font-size: 14px; color: var(--jobs-gray);">Active Agents</div>
                                </div>
                                <div style="background: var(--jobs-light-gray); padding: 16px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 32px; font-weight: 700; color: var(--jobs-orange);">${analysis.estimatedLoad}</div>
                                    <div style="font-size: 14px; color: var(--jobs-gray);">Load Units</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Deployment Tiers -->
                        <div class="properties-section">
                            <h3 class="properties-title">Select Deployment Tier</h3>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px;">
                                ${Object.entries(DEPLOYMENT_TEMPLATES).map(([tier, config]) => `
                                    <div class="deployment-tier ${tier === analysis.recommendedTier ? 'recommended' : ''}" 
                                         onclick="selectDeploymentTier('${tier}')" 
                                         id="tier-${tier}"
                                         style="border: 2px solid ${tier === analysis.recommendedTier ? tierColors[tier] : 'transparent'}; 
                                                padding: 20px; border-radius: 12px; cursor: pointer; 
                                                background: var(--jobs-light-gray); transition: all 0.3s;">
                                        <h4 style="margin: 0 0 8px 0; color: ${tierColors[tier]}; text-transform: capitalize;">
                                            ${tier}
                                            ${tier === analysis.recommendedTier ? ' (Recommended)' : ''}
                                        </h4>
                                        <div style="font-size: 24px; font-weight: 700; margin: 8px 0;">${config.cost}</div>
                                        <ul style="margin: 12px 0; padding-left: 20px; font-size: 14px;">
                                            <li>${config.infrastructure.memory} Memory</li>
                                            <li>${config.infrastructure.instances} Instance${config.infrastructure.instances > 1 ? 's' : ''}</li>
                                            <li>${config.scaling.max} Max Scale</li>
                                        </ul>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Deployment Plan -->
                        <div class="properties-section">
                            <h3 class="properties-title">Deployment Plan</h3>
                            <div id="deployment-plan-details">
                                ${renderDeploymentPlan(analysis.deploymentPlan)}
                            </div>
                        </div>
                        
                        <!-- Smart Contracts -->
                        <div class="properties-section">
                            <h3 class="properties-title">üîó Blockchain Integration</h3>
                            <p style="margin-bottom: 12px;">Smart contracts will be automatically generated and deployed:</p>
                            <ul style="margin-left: 20px;">
                                <li>Process Registry Contract</li>
                                <li>Escrow Contract for Agent Payments</li>
                                <li>Custom Process Contract</li>
                            </ul>
                        </div>
                        
                        <!-- Actions -->
                        <div style="display: flex; gap: 12px; margin-top: 24px;">
                            <button class="jobs-action-button secondary" onclick="this.closest('.agent-modal').remove()">
                                Cancel
                            </button>
                            <button class="jobs-action-button" id="deploy-button" 
                                    style="background: linear-gradient(135deg, var(--jobs-green), var(--jobs-teal)); color: white;"
                                    onclick="executeDeployment('${btoa(JSON.stringify({analysis, bpmnXML, agentIds}))}')">
                                üöÄ Deploy Now
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Auto-select recommended tier
            selectDeploymentTier(analysis.recommendedTier);
        }
        
        function renderDeploymentPlan(plan) {
            return `
                <div style="margin-bottom: 16px;">
                    <strong>Total Duration:</strong> ${plan.totalDuration}
                </div>
                <div style="display: flex; flex-direction: column; gap: 8px;">
                    ${plan.steps.map((step, index) => `
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 32px; height: 32px; border-radius: 50%; 
                                        background: var(--jobs-blue); color: white; 
                                        display: flex; align-items: center; justify-content: center;
                                        font-weight: 600;">
                                ${index + 1}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">${step.name}</div>
                                <div style="font-size: 14px; color: var(--jobs-gray);">
                                    ${step.tasks.join(', ')} (${step.duration})
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        let selectedTier = null;
        function selectDeploymentTier(tier) {
            selectedTier = tier;
            
            // Update UI
            document.querySelectorAll('.deployment-tier').forEach(el => {
                el.style.border = '2px solid transparent';
            });
            
            const selectedEl = document.getElementById(`tier-${tier}`);
            if (selectedEl) {
                const tierColors = {
                    development: '#34C759',
                    staging: '#FF9500',
                    production: '#AF52DE'
                };
                selectedEl.style.border = `2px solid ${tierColors[tier]}`;
            }
        }
        
        async function executeDeployment(encodedData) {
            const { analysis, bpmnXML, agentIds } = JSON.parse(atob(encodedData));
            const button = document.getElementById('deploy-button');
            const originalContent = button.innerHTML;
            button.disabled = true;
            button.innerHTML = 'üöÄ Deploying...';
            
            try {
                // Start deployment
                const response = await fetch('/api/zero-deploy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'deploy',
                        processId: 'process-' + Date.now(),
                        bpmnXML,
                        agentIds,
                        deploymentPlan: analysis.deploymentPlan,
                        tier: selectedTier || analysis.recommendedTier
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    activeDeployment = result.deploymentId;
                    
                    // Close modal and show progress
                    document.querySelector('.agent-modal').remove();
                    showDeploymentProgress(result.deploymentId);
                    
                    // Start polling for status
                    startDeploymentPolling(result.deploymentId);
                }
                
            } catch (error) {
                console.error('Deployment failed:', error);
                showNotification('Deployment failed: ' + error.message, 'error');
                button.disabled = false;
                button.innerHTML = originalContent;
            }
        }
        
        function showDeploymentProgress(deploymentId) {
            const progress = document.createElement('div');
            progress.id = 'deployment-progress';
            progress.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                width: 400px;
                background: white;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(0,0,0,0.1);
                padding: 20px;
                z-index: 2000;
            `;
            
            progress.innerHTML = `
                <h3 style="margin: 0 0 16px 0; font-size: 18px;">üöÄ Deployment Progress</h3>
                <div id="deployment-status">
                    <div style="text-align: center; padding: 20px;">
                        <div class="loading-spinner" style="margin: 0 auto;"></div>
                        <p style="margin-top: 12px; color: var(--jobs-gray);">Initializing deployment...</p>
                    </div>
                </div>
            `;
            
            document.body.appendChild(progress);
        }
        
        async function startDeploymentPolling(deploymentId) {
            if (deploymentInterval) {
                clearInterval(deploymentInterval);
            }
            
            const pollStatus = async () => {
                try {
                    const response = await fetch('/api/zero-deploy', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'status',
                            deploymentId
                        })
                    });
                    
                    const status = await response.json();
                    if (status.success) {
                        updateDeploymentProgress(status);
                        
                        if (status.status === 'deployed') {
                            clearInterval(deploymentInterval);
                            showDeploymentComplete(status);
                        } else if (status.status === 'failed') {
                            clearInterval(deploymentInterval);
                            showDeploymentFailed(status);
                        }
                    }
                } catch (error) {
                    console.error('Failed to poll deployment status:', error);
                }
            };
            
            // Poll immediately
            pollStatus();
            
            // Then poll every 2 seconds
            deploymentInterval = setInterval(pollStatus, 2000);
        }
        
        function updateDeploymentProgress(status) {
            const statusDiv = document.getElementById('deployment-status');
            if (!statusDiv) return;
            
            statusDiv.innerHTML = `
                <div style="margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>Overall Progress</span>
                        <span>${status.progress}%</span>
                    </div>
                    <div style="background: var(--jobs-light-gray); height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="background: var(--jobs-blue); height: 100%; width: ${status.progress}%; transition: width 0.3s;"></div>
                    </div>
                </div>
                
                <div style="font-size: 14px;">
                    ${status.steps.map(step => `
                        <div style="margin-bottom: 8px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                ${step.status === 'completed' ? '‚úÖ' : 
                                  step.status === 'running' ? '‚è≥' : '‚è∏Ô∏è'}
                                <span>${step.name}</span>
                                ${step.duration ? `<span style="color: var(--jobs-gray); margin-left: auto;">${Math.round(step.duration / 1000)}s</span>` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function showDeploymentComplete(status) {
            const progress = document.getElementById('deployment-progress');
            if (!progress) return;
            
            progress.innerHTML = `
                <h3 style="margin: 0 0 16px 0; font-size: 18px; color: var(--jobs-green);">‚úÖ Deployment Complete!</h3>
                <p style="margin-bottom: 16px;">Your process has been successfully deployed.</p>
                
                <div style="background: var(--jobs-light-gray); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <h4 style="margin: 0 0 12px 0; font-size: 14px;">Access URLs:</h4>
                    <div style="font-size: 12px; font-family: monospace;">
                        ${Object.entries(status.urls).map(([name, url]) => `
                            <div style="margin-bottom: 8px;">
                                <strong>${name}:</strong><br>
                                <a href="${url}" target="_blank" style="color: var(--jobs-blue);">${url}</a>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <button class="jobs-action-button" onclick="document.getElementById('deployment-progress').remove()">
                    Close
                </button>
            `;
            
            showNotification('Process deployed successfully! üéâ', 'success', 10000);
        }
        
        function showDeploymentFailed(status) {
            const progress = document.getElementById('deployment-progress');
            if (!progress) return;
            
            progress.innerHTML = `
                <h3 style="margin: 0 0 16px 0; font-size: 18px; color: var(--jobs-red);">‚ùå Deployment Failed</h3>
                <p style="margin-bottom: 16px; color: var(--jobs-red);">
                    ${status.error || 'An unexpected error occurred during deployment.'}
                </p>
                
                <button class="jobs-action-button" onclick="document.getElementById('deployment-progress').remove()">
                    Close
                </button>
            `;
            
            showNotification('Deployment failed. Please try again.', 'error');
        }
        
        // Deployment templates (matching backend)
        const DEPLOYMENT_TEMPLATES = {
            'development': {
                infrastructure: {
                    compute: 'serverless-dev',
                    memory: '512MB',
                    timeout: '30s',
                    instances: 1,
                    region: 'auto'
                },
                services: {
                    database: 'shared-dev',
                    cache: 'redis-dev',
                    monitoring: 'basic'
                },
                scaling: {
                    min: 1,
                    max: 3,
                    targetCPU: 80
                },
                cost: 'Free'
            },
            'staging': {
                infrastructure: {
                    compute: 'container-staging',
                    memory: '2GB',
                    timeout: '60s',
                    instances: 2,
                    region: 'multi-region'
                },
                services: {
                    database: 'dedicated-staging',
                    cache: 'redis-cluster',
                    monitoring: 'advanced',
                    logging: 'centralized'
                },
                scaling: {
                    min: 2,
                    max: 10,
                    targetCPU: 70
                },
                cost: '$50/month'
            },
            'production': {
                infrastructure: {
                    compute: 'kubernetes-prod',
                    memory: '4GB',
                    timeout: '120s',
                    instances: 3,
                    region: 'global'
                },
                services: {
                    database: 'high-availability',
                    cache: 'redis-enterprise',
                    monitoring: 'enterprise',
                    logging: 'full-stack',
                    backup: 'continuous',
                    security: 'enhanced'
                },
                scaling: {
                    min: 3,
                    max: 100,
                    targetCPU: 60,
                    autoScale: true
                },
                cost: '$500/month'
            }
        };
        
        // Check for dark mode
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }
        
        // Initialize on load
        window.addEventListener('load', initModeler);
    </script>
</body>
</html>