<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Process Designer - FinSight Intelligence</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/@blueprintjs/core@4.20.2/lib/css/blueprint.css" rel="stylesheet">
    <link href="apple-hybrid-safe.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@11.5.0/dist/assets/diagram-js.css">
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@11.5.0/dist/assets/bpmn-font/css/bpmn.css">
    <style>
        /* Use the same design system as model-jobs.html */
        :root {
            --jobs-black: #000000;
            --jobs-white: #FFFFFF;
            --jobs-gray: #8E8E93;
            --jobs-light-gray: #F2F2F7;
            --jobs-blue: #007AFF;
            --jobs-green: #34C759;
            --jobs-red: #FF3B30;
            --jobs-orange: #FF9500;
            --jobs-purple: #AF52DE;
            --jobs-teal: #5AC8FA;
            --jobs-pink: #FF2D92;
            
            --jobs-font: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", sans-serif;
            --jobs-font-size-hero: 48px;
            --jobs-font-size-title: 34px;
            --jobs-font-size-headline: 28px;
            --jobs-font-size-body: 17px;
            --jobs-font-size-caption: 13px;
            
            --jobs-spacing-xs: 4px;
            --jobs-spacing-sm: 8px;
            --jobs-spacing-md: 16px;
            --jobs-spacing-lg: 24px;
            --jobs-spacing-xl: 32px;
            --jobs-spacing-xxl: 48px;
            
            --jobs-animation: cubic-bezier(0.25, 0.46, 0.45, 0.94);
            --jobs-duration: 300ms;
        }
        
        * {
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body {
            margin: 0;
            font-family: var(--jobs-font);
            font-size: var(--jobs-font-size-body);
            color: var(--jobs-black);
            background: var(--jobs-white);
            line-height: 1.47;
            overflow: hidden;
        }
        
        body.dark-mode {
            background: var(--jobs-black);
            color: var(--jobs-white);
        }
        
        /* Navigation matching model-jobs.html */
        .jobs-nav {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: flex;
            align-items: center;
            padding: 0 var(--jobs-spacing-lg);
        }
        
        body.dark-mode .jobs-nav {
            background: rgba(0, 0, 0, 0.8);
            border-bottom-color: rgba(255, 255, 255, 0.1);
        }
        
        .jobs-nav-title {
            font-size: 20px;
            font-weight: 600;
            margin-right: auto;
        }
        
        .jobs-nav-actions {
            display: flex;
            gap: var(--jobs-spacing-sm);
        }
        
        .jobs-action-button {
            padding: 8px 16px;
            background: var(--jobs-blue);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--jobs-duration) var(--jobs-animation);
        }
        
        .jobs-action-button:hover {
            background: #0051D5;
            transform: translateY(-1px);
        }
        
        .jobs-action-button.secondary {
            background: transparent;
            color: var(--jobs-blue);
            border: 1px solid var(--jobs-blue);
        }
        
        body.dark-mode .jobs-action-button.secondary {
            color: var(--jobs-blue);
            border-color: var(--jobs-blue);
        }
        
        /* Main Layout */
        .main-container {
            display: flex;
            height: calc(100vh - 56px);
            margin-top: 56px;
        }
        
        /* Left Sidebar - Process Templates */
        .jobs-sidebar {
            width: 320px;
            background: var(--jobs-light-gray);
            border-right: 1px solid rgba(0, 0, 0, 0.1);
            padding: var(--jobs-spacing-lg);
            overflow-y: auto;
        }
        
        body.dark-mode .jobs-sidebar {
            background: #1C1C1E;
            border-right-color: #38383A;
        }
        
        .sidebar-section-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: var(--jobs-spacing-md);
        }
        
        .template-card {
            background: white;
            border-radius: 12px;
            padding: var(--jobs-spacing-md);
            margin-bottom: var(--jobs-spacing-md);
            cursor: pointer;
            transition: all var(--jobs-duration) var(--jobs-animation);
            border: 2px solid transparent;
        }
        
        body.dark-mode .template-card {
            background: #2C2C2E;
        }
        
        .template-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
        }
        
        .template-card.active {
            border-color: var(--jobs-blue);
            background: rgba(0, 122, 255, 0.05);
        }
        
        .template-card h3 {
            font-size: 17px;
            font-weight: 600;
            margin: 0 0 8px;
        }
        
        .template-card p {
            font-size: 14px;
            color: var(--jobs-gray);
            margin: 0 0 12px;
            line-height: 1.4;
        }
        
        .template-agents {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .agent-chip {
            background: rgba(0, 122, 255, 0.1);
            color: var(--jobs-blue);
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
        }
        
        /* Canvas Area */
        .canvas-container {
            flex: 1;
            background: white;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        body.dark-mode .canvas-container {
            background: #000;
        }
        
        .canvas-toolbar {
            background: var(--jobs-light-gray);
            padding: var(--jobs-spacing-sm) var(--jobs-spacing-md);
            display: flex;
            align-items: center;
            gap: var(--jobs-spacing-md);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        body.dark-mode .canvas-toolbar {
            background: #1C1C1E;
            border-bottom-color: #38383A;
        }
        
        .toolbar-group {
            display: flex;
            gap: var(--jobs-spacing-sm);
        }
        
        .toolbar-button {
            padding: 6px 12px;
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all var(--jobs-duration) var(--jobs-animation);
        }
        
        body.dark-mode .toolbar-button {
            background: #2C2C2E;
            border-color: #38383A;
            color: white;
        }
        
        .toolbar-button:hover {
            background: var(--jobs-blue);
            color: white;
            border-color: var(--jobs-blue);
        }
        
        #canvas {
            flex: 1;
            position: relative;
        }
        
        /* Right Panel - Properties */
        .properties-panel {
            width: 360px;
            background: var(--jobs-light-gray);
            border-left: 1px solid rgba(0, 0, 0, 0.1);
            padding: var(--jobs-spacing-lg);
            overflow-y: auto;
        }
        
        body.dark-mode .properties-panel {
            background: #1C1C1E;
            border-left-color: #38383A;
        }
        
        .properties-section {
            margin-bottom: var(--jobs-spacing-xl);
        }
        
        .properties-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: var(--jobs-spacing-md);
        }
        
        .property-field {
            margin-bottom: var(--jobs-spacing-md);
        }
        
        .property-label {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 6px;
            color: var(--jobs-gray);
        }
        
        .property-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            font-size: 15px;
            background: white;
        }
        
        body.dark-mode .property-input {
            background: #2C2C2E;
            border-color: #38383A;
            color: white;
        }
        
        /* BPMN Custom Styles */
        .djs-palette {
            display: none; /* Hide default palette */
        }
        
        .djs-container {
            background: white !important;
        }
        
        body.dark-mode .djs-container {
            background: #000 !important;
        }
        
        /* Custom colors for financial processes */
        .news-sentiment-lane {
            fill: #E8F5E9 !important;
        }
        
        .risk-analysis-lane {
            fill: #FFF3E0 !important;
        }
        
        .trading-lane {
            fill: #E3F2FD !important;
        }
        
        .compliance-lane {
            fill: #FCE4EC !important;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="jobs-nav">
        <div class="jobs-nav-title">Process Designer</div>
        <div class="jobs-nav-actions">
            <button class="jobs-action-button secondary" onclick="window.close()">Back to Agents</button>
            <button class="jobs-action-button" onclick="deployProcess()">Deploy Process</button>
        </div>
    </nav>
    
    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Sidebar - Process Templates -->
        <aside class="jobs-sidebar">
            <h2 class="sidebar-section-title">Financial Process Templates</h2>
            
            <div class="template-card active" onclick="loadTemplate('market-sentiment')">
                <h3>Market Sentiment Analysis</h3>
                <p>Monitors news sentiment and triggers risk adjustments when thresholds are breached</p>
                <div class="template-agents">
                    <span class="agent-chip">News Sentiment Tracker</span>
                    <span class="agent-chip">Risk Calculator</span>
                    <span class="agent-chip">Portfolio Optimizer</span>
                </div>
            </div>
            
            <div class="template-card" onclick="loadTemplate('portfolio-rebalancing')">
                <h3>Portfolio Rebalancing Review</h3>
                <p>Multi-stage approval for major portfolio changes with risk analysis</p>
                <div class="template-agents">
                    <span class="agent-chip">Portfolio Optimizer</span>
                    <span class="agent-chip">Scenario Analyzer</span>
                    <span class="agent-chip">Financial Advisor</span>
                    <span class="agent-chip">Compliance Officer</span>
                </div>
            </div>
            
            <div class="template-card" onclick="loadTemplate('fx-risk-hedge')">
                <h3>FX Risk Hedging</h3>
                <p>Automatic currency hedging when exposure exceeds limits</p>
                <div class="template-agents">
                    <span class="agent-chip">FX Analyzer</span>
                    <span class="agent-chip">Risk Calculator</span>
                    <span class="agent-chip">Trading Strategy</span>
                </div>
            </div>
            
            <div class="template-card" onclick="loadTemplate('compliance-check')">
                <h3>Trade Compliance Workflow</h3>
                <p>Pre-trade compliance checks with escalation for large trades</p>
                <div class="template-agents">
                    <span class="agent-chip">Compliance Officer</span>
                    <span class="agent-chip">Credit Risk Agent</span>
                    <span class="agent-chip">Financial Controller</span>
                </div>
            </div>
        </aside>
        
        <!-- Canvas Area -->
        <div class="canvas-container">
            <div class="canvas-toolbar">
                <div class="toolbar-group">
                    <button class="toolbar-button" onclick="zoomIn()">Zoom In</button>
                    <button class="toolbar-button" onclick="zoomOut()">Zoom Out</button>
                    <button class="toolbar-button" onclick="fitDiagram()">Fit to Screen</button>
                </div>
                <div class="toolbar-group">
                    <button class="toolbar-button" onclick="exportBPMN()">Export BPMN</button>
                    <button class="toolbar-button" onclick="exportImage()">Export Image</button>
                </div>
            </div>
            <div id="canvas"></div>
        </div>
        
        <!-- Right Panel - Properties -->
        <aside class="properties-panel">
            <div class="properties-section">
                <h3 class="properties-title">Process Information</h3>
                <div class="property-field">
                    <div class="property-label">Process Name</div>
                    <input type="text" class="property-input" id="process-name" value="Market Sentiment Analysis Process">
                </div>
                <div class="property-field">
                    <div class="property-label">Description</div>
                    <input type="text" class="property-input" id="process-desc" value="Monitors news and adjusts portfolio based on sentiment">
                </div>
            </div>
            
            <div class="properties-section">
                <h3 class="properties-title">Selected Task</h3>
                <div class="property-field">
                    <div class="property-label">Task Name</div>
                    <input type="text" class="property-input" id="task-name" value="Analyze News Sentiment">
                </div>
                <div class="property-field">
                    <div class="property-label">Assigned Agent</div>
                    <select class="property-input" id="task-agent">
                        <option>News Sentiment Tracker</option>
                        <option>Market Data Collector</option>
                        <option>Portfolio Optimizer</option>
                        <option>Risk Calculator</option>
                    </select>
                </div>
            </div>
            
            <div class="properties-section">
                <h3 class="properties-title">Threshold Settings</h3>
                <div class="property-field">
                    <div class="property-label">Sentiment Trigger</div>
                    <input type="text" class="property-input" value="-0.5">
                </div>
                <div class="property-field">
                    <div class="property-label">VaR Limit</div>
                    <input type="text" class="property-input" value="$1M">
                </div>
            </div>
        </aside>
    </div>
    
    <!-- BPMN.js Scripts -->
    <script src="https://unpkg.com/bpmn-js@11.5.0/dist/bpmn-viewer.production.min.js"></script>
    <script>
        let viewer;
        
        // Market Sentiment Analysis Process BPMN
        const marketSentimentBPMN = `<?xml version="1.0" encoding="UTF-8"?>
<bpmn2:definitions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:bpmn2="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" xmlns:a2a="http://a2a.finsight/schema/1.0" id="market-sentiment" targetNamespace="http://bpmn.io/schema/bpmn">
  <bpmn2:collaboration id="Collaboration_1">
    <bpmn2:participant id="Participant_1" name="Market Sentiment Analysis & Risk Management Process" processRef="Process_1" />
  </bpmn2:collaboration>
  <bpmn2:process id="Process_1" isExecutable="true">
    <bpmn2:laneSet id="LaneSet_1">
      <bpmn2:lane id="Lane_News" name="News & Sentiment Analysis">
        <bpmn2:flowNodeRef>Start_Monitor</bpmn2:flowNodeRef>
        <bpmn2:flowNodeRef>Task_CollectNews</bpmn2:flowNodeRef>
        <bpmn2:flowNodeRef>Task_AnalyzeSentiment</bpmn2:flowNodeRef>
      </bpmn2:lane>
      <bpmn2:lane id="Lane_Risk" name="Risk Assessment">
        <bpmn2:flowNodeRef>Gateway_Check</bpmn2:flowNodeRef>
        <bpmn2:flowNodeRef>Task_CalculateRisk</bpmn2:flowNodeRef>
        <bpmn2:flowNodeRef>Task_RunScenarios</bpmn2:flowNodeRef>
      </bpmn2:lane>
      <bpmn2:lane id="Lane_Trading" name="Trading Execution">
        <bpmn2:flowNodeRef>Task_OptimizePortfolio</bpmn2:flowNodeRef>
        <bpmn2:flowNodeRef>Task_ExecuteHedge</bpmn2:flowNodeRef>
        <bpmn2:flowNodeRef>Gateway_Approval</bpmn2:flowNodeRef>
      </bpmn2:lane>
      <bpmn2:lane id="Lane_Compliance" name="Compliance & Reporting">
        <bpmn2:flowNodeRef>Task_CheckCompliance</bpmn2:flowNodeRef>
        <bpmn2:flowNodeRef>Task_GenerateReport</bpmn2:flowNodeRef>
        <bpmn2:flowNodeRef>End_Complete</bpmn2:flowNodeRef>
        <bpmn2:flowNodeRef>End_NoAction</bpmn2:flowNodeRef>
      </bpmn2:lane>
    </bpmn2:laneSet>
    
    <bpmn2:startEvent id="Start_Monitor" name="Continuous Monitoring">
      <bpmn2:outgoing>Flow_1</bpmn2:outgoing>
      <bpmn2:timerEventDefinition>
        <bpmn2:timeCycle>R/PT5M</bpmn2:timeCycle>
      </bpmn2:timerEventDefinition>
    </bpmn2:startEvent>
    
    <bpmn2:serviceTask id="Task_CollectNews" name="Collect Market News" a2a:agent="Market Data Collector">
      <bpmn2:incoming>Flow_1</bpmn2:incoming>
      <bpmn2:outgoing>Flow_2</bpmn2:outgoing>
    </bpmn2:serviceTask>
    
    <bpmn2:serviceTask id="Task_AnalyzeSentiment" name="Analyze News Sentiment" a2a:agent="News Sentiment Tracker">
      <bpmn2:incoming>Flow_2</bpmn2:incoming>
      <bpmn2:outgoing>Flow_3</bpmn2:outgoing>
    </bpmn2:serviceTask>
    
    <bpmn2:exclusiveGateway id="Gateway_Check" name="Sentiment < -0.5?">
      <bpmn2:incoming>Flow_3</bpmn2:incoming>
      <bpmn2:outgoing>Flow_4</bpmn2:outgoing>
      <bpmn2:outgoing>Flow_NoAction</bpmn2:outgoing>
    </bpmn2:exclusiveGateway>
    
    <bpmn2:serviceTask id="Task_CalculateRisk" name="Calculate Portfolio Risk" a2a:agent="Risk Calculator">
      <bpmn2:incoming>Flow_4</bpmn2:incoming>
      <bpmn2:outgoing>Flow_5</bpmn2:outgoing>
    </bpmn2:serviceTask>
    
    <bpmn2:serviceTask id="Task_RunScenarios" name="Run Stress Test Scenarios" a2a:agent="Scenario Analyzer">
      <bpmn2:incoming>Flow_5</bpmn2:incoming>
      <bpmn2:outgoing>Flow_6</bpmn2:outgoing>
    </bpmn2:serviceTask>
    
    <bpmn2:serviceTask id="Task_OptimizePortfolio" name="Generate Hedge Strategy" a2a:agent="Portfolio Optimizer">
      <bpmn2:incoming>Flow_6</bpmn2:incoming>
      <bpmn2:outgoing>Flow_7</bpmn2:outgoing>
    </bpmn2:serviceTask>
    
    <bpmn2:userTask id="Gateway_Approval" name="Review & Approve Strategy" a2a:agent="Financial Advisor">
      <bpmn2:incoming>Flow_7</bpmn2:incoming>
      <bpmn2:outgoing>Flow_8</bpmn2:outgoing>
      <bpmn2:outgoing>Flow_Reject</bpmn2:outgoing>
    </bpmn2:userTask>
    
    <bpmn2:serviceTask id="Task_ExecuteHedge" name="Execute Hedge Trades" a2a:agent="Trading Strategy">
      <bpmn2:incoming>Flow_8</bpmn2:incoming>
      <bpmn2:outgoing>Flow_9</bpmn2:outgoing>
    </bpmn2:serviceTask>
    
    <bpmn2:serviceTask id="Task_CheckCompliance" name="Verify Trade Compliance" a2a:agent="Compliance Officer">
      <bpmn2:incoming>Flow_9</bpmn2:incoming>
      <bpmn2:outgoing>Flow_10</bpmn2:outgoing>
    </bpmn2:serviceTask>
    
    <bpmn2:serviceTask id="Task_GenerateReport" name="Generate Risk Report" a2a:agent="Report Generator">
      <bpmn2:incoming>Flow_10</bpmn2:incoming>
      <bpmn2:outgoing>Flow_11</bpmn2:outgoing>
    </bpmn2:serviceTask>
    
    <bpmn2:endEvent id="End_Complete" name="Risk Mitigation Complete">
      <bpmn2:incoming>Flow_11</bpmn2:incoming>
    </bpmn2:endEvent>
    
    <bpmn2:endEvent id="End_NoAction" name="No Action Required">
      <bpmn2:incoming>Flow_NoAction</bpmn2:incoming>
      <bpmn2:incoming>Flow_Reject</bpmn2:incoming>
    </bpmn2:endEvent>
    
    <!-- Sequence Flows -->
    <bpmn2:sequenceFlow id="Flow_1" sourceRef="Start_Monitor" targetRef="Task_CollectNews" />
    <bpmn2:sequenceFlow id="Flow_2" sourceRef="Task_CollectNews" targetRef="Task_AnalyzeSentiment" />
    <bpmn2:sequenceFlow id="Flow_3" sourceRef="Task_AnalyzeSentiment" targetRef="Gateway_Check" />
    <bpmn2:sequenceFlow id="Flow_4" name="Yes" sourceRef="Gateway_Check" targetRef="Task_CalculateRisk" />
    <bpmn2:sequenceFlow id="Flow_NoAction" name="No" sourceRef="Gateway_Check" targetRef="End_NoAction" />
    <bpmn2:sequenceFlow id="Flow_5" sourceRef="Task_CalculateRisk" targetRef="Task_RunScenarios" />
    <bpmn2:sequenceFlow id="Flow_6" sourceRef="Task_RunScenarios" targetRef="Task_OptimizePortfolio" />
    <bpmn2:sequenceFlow id="Flow_7" sourceRef="Task_OptimizePortfolio" targetRef="Gateway_Approval" />
    <bpmn2:sequenceFlow id="Flow_8" name="Approved" sourceRef="Gateway_Approval" targetRef="Task_ExecuteHedge" />
    <bpmn2:sequenceFlow id="Flow_Reject" name="Rejected" sourceRef="Gateway_Approval" targetRef="End_NoAction" />
    <bpmn2:sequenceFlow id="Flow_9" sourceRef="Task_ExecuteHedge" targetRef="Task_CheckCompliance" />
    <bpmn2:sequenceFlow id="Flow_10" sourceRef="Task_CheckCompliance" targetRef="Task_GenerateReport" />
    <bpmn2:sequenceFlow id="Flow_11" sourceRef="Task_GenerateReport" targetRef="End_Complete" />
  </bpmn2:process>
  
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Collaboration_1">
      <bpmndi:BPMNShape id="Participant_1_di" bpmnElement="Participant_1" isHorizontal="true">
        <dc:Bounds x="160" y="80" width="1200" height="600" />
      </bpmndi:BPMNShape>
      
      <!-- Lanes -->
      <bpmndi:BPMNShape id="Lane_News_di" bpmnElement="Lane_News" isHorizontal="true">
        <dc:Bounds x="190" y="80" width="1170" height="150" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Lane_Risk_di" bpmnElement="Lane_Risk" isHorizontal="true">
        <dc:Bounds x="190" y="230" width="1170" height="150" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Lane_Trading_di" bpmnElement="Lane_Trading" isHorizontal="true">
        <dc:Bounds x="190" y="380" width="1170" height="150" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Lane_Compliance_di" bpmnElement="Lane_Compliance" isHorizontal="true">
        <dc:Bounds x="190" y="530" width="1170" height="150" />
      </bpmndi:BPMNShape>
      
      <!-- Elements -->
      <bpmndi:BPMNShape id="Start_Monitor_di" bpmnElement="Start_Monitor">
        <dc:Bounds x="242" y="137" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="228" y="180" width="65" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      
      <bpmndi:BPMNShape id="Task_CollectNews_di" bpmnElement="Task_CollectNews">
        <dc:Bounds x="330" y="115" width="100" height="80" />
      </bpmndi:BPMNShape>
      
      <bpmndi:BPMNShape id="Task_AnalyzeSentiment_di" bpmnElement="Task_AnalyzeSentiment">
        <dc:Bounds x="480" y="115" width="100" height="80" />
      </bpmndi:BPMNShape>
      
      <bpmndi:BPMNShape id="Gateway_Check_di" bpmnElement="Gateway_Check" isMarkerVisible="true">
        <dc:Bounds x="505" y="280" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="488" y="337" width="85" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      
      <bpmndi:BPMNShape id="Task_CalculateRisk_di" bpmnElement="Task_CalculateRisk">
        <dc:Bounds x="630" y="265" width="100" height="80" />
      </bpmndi:BPMNShape>
      
      <bpmndi:BPMNShape id="Task_RunScenarios_di" bpmnElement="Task_RunScenarios">
        <dc:Bounds x="780" y="265" width="100" height="80" />
      </bpmndi:BPMNShape>
      
      <bpmndi:BPMNShape id="Task_OptimizePortfolio_di" bpmnElement="Task_OptimizePortfolio">
        <dc:Bounds x="780" y="415" width="100" height="80" />
      </bpmndi:BPMNShape>
      
      <bpmndi:BPMNShape id="Gateway_Approval_di" bpmnElement="Gateway_Approval">
        <dc:Bounds x="930" y="415" width="100" height="80" />
      </bpmndi:BPMNShape>
      
      <bpmndi:BPMNShape id="Task_ExecuteHedge_di" bpmnElement="Task_ExecuteHedge">
        <dc:Bounds x="1080" y="415" width="100" height="80" />
      </bpmndi:BPMNShape>
      
      <bpmndi:BPMNShape id="Task_CheckCompliance_di" bpmnElement="Task_CheckCompliance">
        <dc:Bounds x="1080" y="565" width="100" height="80" />
      </bpmndi:BPMNShape>
      
      <bpmndi:BPMNShape id="Task_GenerateReport_di" bpmnElement="Task_GenerateReport">
        <dc:Bounds x="1230" y="565" width="100" height="80" />
      </bpmndi:BPMNShape>
      
      <bpmndi:BPMNShape id="End_Complete_di" bpmnElement="End_Complete">
        <dc:Bounds x="1282" y="682" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1262" y="725" width="76" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      
      <bpmndi:BPMNShape id="End_NoAction_di" bpmnElement="End_NoAction">
        <dc:Bounds x="512" y="587" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="506" y="630" width="48" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      
      <!-- Flows -->
      <bpmndi:BPMNEdge id="Flow_1_di" bpmnElement="Flow_1">
        <di:waypoint x="278" y="155" />
        <di:waypoint x="330" y="155" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_2_di" bpmnElement="Flow_2">
        <di:waypoint x="430" y="155" />
        <di:waypoint x="480" y="155" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_3_di" bpmnElement="Flow_3">
        <di:waypoint x="530" y="195" />
        <di:waypoint x="530" y="280" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_4_di" bpmnElement="Flow_4">
        <di:waypoint x="555" y="305" />
        <di:waypoint x="630" y="305" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="584" y="287" width="18" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_NoAction_di" bpmnElement="Flow_NoAction">
        <di:waypoint x="530" y="330" />
        <di:waypoint x="530" y="587" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="538" y="456" width="15" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_5_di" bpmnElement="Flow_5">
        <di:waypoint x="730" y="305" />
        <di:waypoint x="780" y="305" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_6_di" bpmnElement="Flow_6">
        <di:waypoint x="830" y="345" />
        <di:waypoint x="830" y="415" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_7_di" bpmnElement="Flow_7">
        <di:waypoint x="880" y="455" />
        <di:waypoint x="930" y="455" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_8_di" bpmnElement="Flow_8">
        <di:waypoint x="1030" y="455" />
        <di:waypoint x="1080" y="455" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1035" y="437" width="48" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_Reject_di" bpmnElement="Flow_Reject">
        <di:waypoint x="980" y="495" />
        <di:waypoint x="980" y="605" />
        <di:waypoint x="548" y="605" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="974" y="547" width="44" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_9_di" bpmnElement="Flow_9">
        <di:waypoint x="1130" y="495" />
        <di:waypoint x="1130" y="565" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_10_di" bpmnElement="Flow_10">
        <di:waypoint x="1180" y="605" />
        <di:waypoint x="1230" y="605" />
      </bpmndi:BPMNEdge>
      
      <bpmndi:BPMNEdge id="Flow_11_di" bpmnElement="Flow_11">
        <di:waypoint x="1280" y="645" />
        <di:waypoint x="1280" y="700" />
        <di:waypoint x="1282" y="700" />
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn2:definitions>`;
        
        // Initialize the viewer
        function initViewer() {
            viewer = new BpmnJS({
                container: '#canvas',
                keyboard: {
                    bindTo: document
                }
            });
            
            // Load the diagram
            viewer.importXML(marketSentimentBPMN).then(() => {
                viewer.get('canvas').zoom('fit-viewport');
                
                // Color the lanes based on function
                const elementRegistry = viewer.get('elementRegistry');
                const modeling = viewer.get('modeling');
                
                // Color lanes
                const lanes = elementRegistry.filter(element => element.type === 'bpmn:Lane');
                lanes.forEach(lane => {
                    if (lane.businessObject.name === 'News & Sentiment Analysis') {
                        modeling.setColor(lane, { fill: '#E8F5E9' });
                    } else if (lane.businessObject.name === 'Risk Assessment') {
                        modeling.setColor(lane, { fill: '#FFF3E0' });
                    } else if (lane.businessObject.name === 'Trading Execution') {
                        modeling.setColor(lane, { fill: '#E3F2FD' });
                    } else if (lane.businessObject.name === 'Compliance & Reporting') {
                        modeling.setColor(lane, { fill: '#FCE4EC' });
                    }
                });
                
                // Color tasks by type
                elementRegistry.filter(e => e.type === 'bpmn:ServiceTask').forEach(task => {
                    modeling.setColor(task, { fill: '#BBDEFB', stroke: '#1976D2' });
                });
                
                elementRegistry.filter(e => e.type === 'bpmn:UserTask').forEach(task => {
                    modeling.setColor(task, { fill: '#C8E6C9', stroke: '#388E3C' });
                });
            });
        }
        
        // Zoom controls
        function zoomIn() {
            viewer.get('zoomScroll').stepZoom(0.2);
        }
        
        function zoomOut() {
            viewer.get('zoomScroll').stepZoom(-0.2);
        }
        
        function fitDiagram() {
            viewer.get('canvas').zoom('fit-viewport');
        }
        
        // Export functions
        function exportBPMN() {
            viewer.saveXML({ format: true }).then(result => {
                const blob = new Blob([result.xml], { type: 'application/xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'finsight-process.bpmn';
                a.click();
            });
        }
        
        function exportImage() {
            viewer.saveSVG().then(result => {
                const blob = new Blob([result.svg], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'finsight-process.svg';
                a.click();
            });
        }
        
        // Template loading
        function loadTemplate(templateId) {
            // Update active state
            document.querySelectorAll('.template-card').forEach(card => {
                card.classList.remove('active');
            });
            event.target.closest('.template-card').classList.add('active');
            
            // Update process info
            const templates = {
                'market-sentiment': {
                    name: 'Market Sentiment Analysis Process',
                    desc: 'Monitors news and adjusts portfolio based on sentiment'
                },
                'portfolio-rebalancing': {
                    name: 'Portfolio Rebalancing Review Process',
                    desc: 'Multi-stage approval for major portfolio changes'
                },
                'fx-risk-hedge': {
                    name: 'FX Risk Hedging Process',
                    desc: 'Automatic currency hedging when exposure exceeds limits'
                },
                'compliance-check': {
                    name: 'Trade Compliance Workflow',
                    desc: 'Pre-trade compliance checks with escalation'
                }
            };
            
            const template = templates[templateId];
            document.getElementById('process-name').value = template.name;
            document.getElementById('process-desc').value = template.desc;
        }
        
        // Deploy process
        function deployProcess() {
            alert('Deploying Process to A2A Network:\n\n' +
                  '1. Converting BPMN to smart contracts\n' +
                  '2. Assigning agents to tasks\n' +
                  '3. Setting thresholds and rules\n' +
                  '4. Deploying to blockchain\n\n' +
                  'Process will be live in ~30 seconds');
        }
        
        // Check for dark mode
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }
        
        // Initialize on load
        window.addEventListener('load', initViewer);
    </script>
</body>
</html>