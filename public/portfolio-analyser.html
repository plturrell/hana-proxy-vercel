<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Analyser - Financial Analytics Platform</title>
    <style>
        :root {
            --bg: #000;
            --bg-secondary: #0a0a0a;
            --border: #333;
            --text: #fff;
            --text-secondary: #999;
            --accent: #3ecf8e;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        .back-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
        }
        
        .portfolio-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .summary-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
        }
        
        .summary-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }
        
        .summary-value {
            font-size: 1.75rem;
            font-weight: 600;
        }
        
        .positive {
            color: var(--accent);
        }
        
        .negative {
            color: var(--danger);
        }
        
        .analysis-sections {
            display: grid;
            gap: 2rem;
        }
        
        .analysis-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .refresh-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
        }
        
        .refresh-btn:hover {
            border-color: var(--accent);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th,
        .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        .data-table th {
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .data-table td {
            font-size: 0.875rem;
        }
        
        .risk-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .risk-item {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
        }
        
        .risk-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }
        
        .risk-value {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .chart-container {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 50%;
            border-top-color: var(--accent);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .btn {
            background: var(--accent);
            color: var(--bg);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: transparent;
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>Portfolio Analyser</h1>
                <p style="color: var(--text-secondary);">Comprehensive portfolio risk and performance analysis</p>
            </div>
            <a href="/" class="back-btn">‚Üê Back to Dashboard</a>
        </div>
        
        <div class="portfolio-summary">
            <div class="summary-card">
                <div class="summary-label">Total Value</div>
                <div class="summary-value" id="totalValue">
                    <span class="loading"></span>
                </div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Daily Return</div>
                <div class="summary-value" id="dailyReturn">
                    <span class="loading"></span>
                </div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Sharpe Ratio</div>
                <div class="summary-value" id="sharpeRatio">
                    <span class="loading"></span>
                </div>
            </div>
            <div class="summary-card">
                <div class="summary-label">Value at Risk (95%)</div>
                <div class="summary-value" id="varValue">
                    <span class="loading"></span>
                </div>
            </div>
        </div>
        
        <div class="analysis-sections">
            <div class="analysis-card">
                <div class="card-header">
                    <h2 class="card-title">Portfolio Composition</h2>
                    <button class="refresh-btn" onclick="loadPortfolioData()">‚Üª Refresh</button>
                </div>
                <table class="data-table" id="portfolioTable">
                    <thead>
                        <tr>
                            <th>Asset</th>
                            <th>Weight</th>
                            <th>Value</th>
                            <th>Daily Return</th>
                            <th>Volatility</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="5" style="text-align: center; color: var(--text-secondary);">
                                Loading portfolio data...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="analysis-card">
                <div class="card-header">
                    <h2 class="card-title">Risk Analysis</h2>
                    <button class="refresh-btn" onclick="runRiskAnalysis()">‚Üª Recalculate</button>
                </div>
                <div class="risk-metrics">
                    <div class="risk-item">
                        <div class="risk-label">Beta</div>
                        <div class="risk-value" id="betaValue">-</div>
                    </div>
                    <div class="risk-item">
                        <div class="risk-label">Tracking Error</div>
                        <div class="risk-value" id="trackingError">-</div>
                    </div>
                    <div class="risk-item">
                        <div class="risk-label">Information Ratio</div>
                        <div class="risk-value" id="infoRatio">-</div>
                    </div>
                    <div class="risk-item">
                        <div class="risk-label">Max Drawdown</div>
                        <div class="risk-value" id="maxDrawdown">-</div>
                    </div>
                </div>
                <div class="chart-container" id="riskChart">
                    <span style="color: var(--text-secondary);">Risk distribution chart will appear here</span>
                </div>
            </div>
            
            <div class="analysis-card">
                <div class="card-header">
                    <h2 class="card-title">Correlation Matrix</h2>
                    <button class="refresh-btn" onclick="calculateCorrelations()">‚Üª Update</button>
                </div>
                <div id="correlationMatrix" style="overflow-x: auto;">
                    <table class="data-table">
                        <tbody>
                            <tr>
                                <td style="text-align: center; color: var(--text-secondary);">
                                    Click "Update" to calculate asset correlations
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn" onclick="optimizePortfolio()">
                    üéØ Optimize Portfolio
                </button>
                <button class="btn btn-secondary" onclick="runMonteCarloSimulation()">
                    üìä Run Monte Carlo Simulation
                </button>
                <button class="btn btn-secondary" onclick="exportAnalysis()">
                    üì• Export Analysis
                </button>
            </div>
        </div>
    </div>
    
    <script>
        const API_URL = '/api/supabase-proxy';
        
        // Sample portfolio data (in production, this would come from user input or database)
        const samplePortfolio = [
            { asset: 'AAPL', weight: 0.25, shares: 150 },
            { asset: 'GOOGL', weight: 0.20, shares: 80 },
            { asset: 'MSFT', weight: 0.15, shares: 100 },
            { asset: 'AMZN', weight: 0.15, shares: 50 },
            { asset: 'BRK-B', weight: 0.25, shares: 200 }
        ];
        
        // Sample historical returns for demonstration
        const historicalReturns = {
            'AAPL': [0.02, -0.01, 0.03, -0.02, 0.01, 0.02, -0.01, 0.01, 0.02, -0.01],
            'GOOGL': [0.01, 0.02, -0.01, 0.01, 0.02, -0.01, 0.02, 0.01, -0.01, 0.02],
            'MSFT': [0.03, -0.02, 0.01, 0.02, -0.01, 0.03, -0.01, 0.02, 0.01, -0.02],
            'AMZN': [-0.01, 0.03, -0.02, 0.01, 0.03, -0.02, 0.01, 0.02, -0.01, 0.03],
            'BRK-B': [0.01, 0.01, 0.01, -0.01, 0.01, 0.01, -0.01, 0.01, 0.01, 0.01]
        };
        
        async function loadPortfolioData() {
            try {
                const tbody = document.querySelector('#portfolioTable tbody');
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;"><span class="loading"></span></td></tr>';
                
                // Calculate portfolio metrics
                let totalValue = 0;
                let portfolioReturns = [];
                
                const rows = [];
                for (const holding of samplePortfolio) {
                    const value = holding.shares * (100 + Math.random() * 100); // Simulated price
                    totalValue += value;
                    
                    const returns = historicalReturns[holding.asset];
                    const avgReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
                    const volatility = Math.sqrt(returns.map(r => Math.pow(r - avgReturn, 2)).reduce((a, b) => a + b, 0) / returns.length);
                    
                    rows.push(`
                        <tr>
                            <td><strong>${holding.asset}</strong></td>
                            <td>${(holding.weight * 100).toFixed(1)}%</td>
                            <td>$${value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                            <td class="${avgReturn >= 0 ? 'positive' : 'negative'}">${avgReturn >= 0 ? '+' : ''}${(avgReturn * 100).toFixed(2)}%</td>
                            <td>${(volatility * 100).toFixed(2)}%</td>
                        </tr>
                    `);
                }
                
                tbody.innerHTML = rows.join('');
                
                // Update summary cards
                document.getElementById('totalValue').innerHTML = `$${totalValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                
                // Calculate portfolio returns
                const portfolioReturn = samplePortfolio.reduce((total, holding, i) => {
                    const returns = historicalReturns[holding.asset];
                    const avgReturn = returns.reduce((a, b) => a + b, 0) / returns.length;
                    return total + (holding.weight * avgReturn);
                }, 0);
                
                document.getElementById('dailyReturn').innerHTML = `<span class="${portfolioReturn >= 0 ? 'positive' : 'negative'}">${portfolioReturn >= 0 ? '+' : ''}${(portfolioReturn * 100).toFixed(2)}%</span>`;
                
                // Calculate Sharpe Ratio
                await calculateSharpeRatio();
                
                // Calculate VaR
                await calculateVaR();
                
            } catch (error) {
                console.error('Failed to load portfolio data:', error);
                document.querySelector('#portfolioTable tbody').innerHTML = `
                    <tr><td colspan="5" style="text-align: center; color: var(--danger);">Failed to load portfolio data</td></tr>
                `;
            }
        }
        
        async function calculateSharpeRatio() {
            try {
                // Calculate portfolio returns weighted by holdings
                const portfolioReturns = [];
                for (let i = 0; i < 10; i++) {
                    let dayReturn = 0;
                    samplePortfolio.forEach(holding => {
                        dayReturn += holding.weight * historicalReturns[holding.asset][i];
                    });
                    portfolioReturns.push(dayReturn);
                }
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'rpc',
                        function_name: 'calculate_sharpe_ratio',
                        params: {
                            returns: portfolioReturns,
                            risk_free_rate: 0.02 / 252 // Daily risk-free rate
                        }
                    })
                });
                
                const data = await response.json();
                if (data.data !== undefined) {
                    document.getElementById('sharpeRatio').innerHTML = `<span class="${data.data >= 1 ? 'positive' : data.data < 0 ? 'negative' : ''}">${data.data.toFixed(2)}</span>`;
                } else {
                    document.getElementById('sharpeRatio').textContent = 'N/A';
                }
            } catch (error) {
                console.error('Failed to calculate Sharpe ratio:', error);
                document.getElementById('sharpeRatio').textContent = 'Error';
            }
        }
        
        async function calculateVaR() {
            try {
                // Calculate portfolio returns
                const portfolioReturns = [];
                for (let i = 0; i < 10; i++) {
                    let dayReturn = 0;
                    samplePortfolio.forEach(holding => {
                        dayReturn += holding.weight * historicalReturns[holding.asset][i];
                    });
                    portfolioReturns.push(dayReturn);
                }
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'rpc',
                        function_name: 'calculate_var',
                        params: {
                            returns: portfolioReturns,
                            confidence_level: 0.95
                        }
                    })
                });
                
                const data = await response.json();
                if (data.data !== undefined) {
                    document.getElementById('varValue').innerHTML = `<span class="negative">${(data.data * 100).toFixed(2)}%</span>`;
                } else {
                    document.getElementById('varValue').textContent = 'N/A';
                }
            } catch (error) {
                console.error('Failed to calculate VaR:', error);
                document.getElementById('varValue').textContent = 'Error';
            }
        }
        
        async function runRiskAnalysis() {
            const metrics = ['betaValue', 'trackingError', 'infoRatio', 'maxDrawdown'];
            metrics.forEach(id => {
                document.getElementById(id).innerHTML = '<span class="loading"></span>';
            });
            
            try {
                // Calculate beta against market (using SPY as proxy)
                const marketReturns = [0.01, 0.01, -0.01, 0.01, 0.01, -0.01, 0.01, 0.01, -0.01, 0.01];
                const portfolioReturns = [];
                for (let i = 0; i < 10; i++) {
                    let dayReturn = 0;
                    samplePortfolio.forEach(holding => {
                        dayReturn += holding.weight * historicalReturns[holding.asset][i];
                    });
                    portfolioReturns.push(dayReturn);
                }
                
                const betaResponse = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'rpc',
                        function_name: 'calculate_beta',
                        params: {
                            asset_returns: portfolioReturns,
                            market_returns: marketReturns
                        }
                    })
                });
                
                const betaData = await betaResponse.json();
                if (betaData.data !== undefined) {
                    document.getElementById('betaValue').textContent = betaData.data.toFixed(2);
                }
                
                // Calculate tracking error
                const trackingErrorResponse = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'rpc',
                        function_name: 'calculate_tracking_error',
                        params: {
                            portfolio_returns: portfolioReturns,
                            benchmark_returns: marketReturns
                        }
                    })
                });
                
                const trackingErrorData = await trackingErrorResponse.json();
                if (trackingErrorData.data !== undefined) {
                    document.getElementById('trackingError').textContent = (trackingErrorData.data * 100).toFixed(2) + '%';
                }
                
                // Calculate information ratio
                const infoRatioResponse = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'rpc',
                        function_name: 'calculate_information_ratio',
                        params: {
                            portfolio_returns: portfolioReturns,
                            benchmark_returns: marketReturns
                        }
                    })
                });
                
                const infoRatioData = await infoRatioResponse.json();
                if (infoRatioData.data !== undefined) {
                    document.getElementById('infoRatio').textContent = infoRatioData.data.toFixed(2);
                }
                
                // Calculate max drawdown
                const maxDrawdownResponse = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'rpc',
                        function_name: 'calculate_max_drawdown',
                        params: {
                            returns: portfolioReturns
                        }
                    })
                });
                
                const maxDrawdownData = await maxDrawdownResponse.json();
                if (maxDrawdownData.data !== undefined) {
                    document.getElementById('maxDrawdown').innerHTML = `<span class="negative">${(maxDrawdownData.data * 100).toFixed(2)}%</span>`;
                }
                
            } catch (error) {
                console.error('Risk analysis failed:', error);
                metrics.forEach(id => {
                    document.getElementById(id).textContent = 'Error';
                });
            }
        }
        
        async function calculateCorrelations() {
            const matrixDiv = document.getElementById('correlationMatrix');
            matrixDiv.innerHTML = '<div style="text-align: center; padding: 2rem;"><span class="loading"></span></div>';
            
            try {
                // Build correlation matrix
                const assets = Object.keys(historicalReturns);
                let tableHTML = '<table class="data-table"><thead><tr><th></th>';
                
                assets.forEach(asset => {
                    tableHTML += `<th>${asset}</th>`;
                });
                tableHTML += '</tr></thead><tbody>';
                
                for (let i = 0; i < assets.length; i++) {
                    tableHTML += `<tr><th>${assets[i]}</th>`;
                    
                    for (let j = 0; j < assets.length; j++) {
                        if (i === j) {
                            tableHTML += '<td style="background: var(--bg); text-align: center;">1.00</td>';
                        } else {
                            const response = await fetch(API_URL, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    action: 'rpc',
                                    function_name: 'calculate_pearson_correlation',
                                    params: {
                                        x_values: historicalReturns[assets[i]],
                                        y_values: historicalReturns[assets[j]]
                                    }
                                })
                            });
                            
                            const data = await response.json();
                            const correlation = data.data || 0;
                            const color = correlation > 0.5 ? 'var(--accent)' : correlation < -0.5 ? 'var(--danger)' : 'var(--text)';
                            tableHTML += `<td style="text-align: center; color: ${color};">${correlation.toFixed(2)}</td>`;
                        }
                    }
                    tableHTML += '</tr>';
                }
                
                tableHTML += '</tbody></table>';
                matrixDiv.innerHTML = tableHTML;
                
            } catch (error) {
                console.error('Failed to calculate correlations:', error);
                matrixDiv.innerHTML = '<div class="error-message">Failed to calculate correlation matrix</div>';
            }
        }
        
        async function optimizePortfolio() {
            alert('Portfolio optimization would use the mean_variance_optimization function to find optimal weights');
        }
        
        async function runMonteCarloSimulation() {
            alert('Monte Carlo simulation would project portfolio performance over multiple scenarios');
        }
        
        function exportAnalysis() {
            alert('Export functionality would generate a PDF or CSV report of the analysis');
        }
        
        // Initialize
        loadPortfolioData();
        
        // Auto-refresh every 60 seconds
        setInterval(loadPortfolioData, 60000);
    </script>
</body>
</html>