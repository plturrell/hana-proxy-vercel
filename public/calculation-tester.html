<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculation Tester - FinSight Intelligence</title>
    <link href="shared-header-styles.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .nav-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 40px;
            padding: 20px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-left {
            display: flex;
            align-items: center;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            margin-right: 20px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .page-title {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #00D4FF, #5B8DEF);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 350px 1fr 400px;
            gap: 30px;
            height: calc(100vh - 180px);
        }

        .formula-panel {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 25px;
            overflow-y: auto;
        }

        .calculation-area {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 25px;
            overflow-y: auto;
        }

        .results-panel {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 25px;
            overflow-y: auto;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #ffffff;
        }

        .formula-category {
            margin-bottom: 25px;
        }

        .category-title {
            font-size: 16px;
            font-weight: 600;
            color: #5B8DEF;
            margin-bottom: 10px;
            padding: 8px 12px;
            background: rgba(91, 141, 239, 0.1);
            border-radius: 8px;
        }

        .formula-item {
            padding: 12px 16px;
            margin: 5px 0;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .formula-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #5B8DEF;
        }

        .formula-item.active {
            background: rgba(91, 141, 239, 0.2);
            border-color: #5B8DEF;
        }

        .formula-name {
            font-weight: 500;
            font-size: 14px;
        }

        .formula-complexity {
            font-size: 10px;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
        }

        .complexity-basic {
            background: rgba(52, 199, 89, 0.2);
            color: #34C759;
        }

        .complexity-intermediate {
            background: rgba(255, 159, 10, 0.2);
            color: #FF9F0A;
        }

        .complexity-advanced {
            background: rgba(255, 69, 58, 0.2);
            color: #FF453A;
        }

        .parameter-section {
            margin-bottom: 30px;
        }

        .parameter-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .parameter-type-title {
            font-size: 16px;
            font-weight: 600;
            color: #ffffff;
        }

        .parameter-count {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.1);
            padding: 4px 8px;
            border-radius: 12px;
        }

        .parameter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .parameter-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
        }

        .parameter-label {
            font-size: 14px;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .parameter-source {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }

        .source-fixed {
            background: rgba(255, 159, 10, 0.2);
            color: #FF9F0A;
        }

        .source-scenario {
            background: rgba(91, 141, 239, 0.2);
            color: #5B8DEF;
        }

        .source-chained {
            background: rgba(52, 199, 89, 0.2);
            color: #34C759;
        }

        .source-user {
            background: rgba(255, 69, 58, 0.2);
            color: #FF453A;
        }

        .parameter-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 10px 12px;
            color: #ffffff;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .parameter-input:focus {
            outline: none;
            border-color: #5B8DEF;
            box-shadow: 0 0 0 2px rgba(91, 141, 239, 0.2);
        }

        .parameter-input:disabled {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.5);
            cursor: not-allowed;
        }

        .parameter-description {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 5px;
        }

        .calculate-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 20px 0;
            transition: all 0.3s ease;
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .calculate-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .result-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .result-label {
            font-weight: 600;
            color: #ffffff;
        }

        .result-timestamp {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
        }

        .result-value {
            font-size: 24px;
            font-weight: 700;
            color: #4ade80;
            margin-bottom: 8px;
        }

        .result-interpretation {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .result-metadata {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            font-size: 11px;
        }

        .metadata-item {
            color: rgba(255, 255, 255, 0.6);
        }

        .metadata-label {
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
        }

        .formula-equation {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #5B8DEF;
            overflow-x: auto;
        }

        .chain-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 10px 0;
            padding: 8px 12px;
            background: rgba(52, 199, 89, 0.1);
            border: 1px solid rgba(52, 199, 89, 0.3);
            border-radius: 6px;
            font-size: 12px;
        }

        .chain-arrow {
            color: #34C759;
        }

        .scenario-selector {
            margin-bottom: 20px;
        }

        .scenario-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .scenario-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 10px 12px;
            color: white;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .scenario-btn.active {
            background: rgba(91, 141, 239, 0.2);
            border-color: #5B8DEF;
        }

        .scenario-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        @keyframes calculating {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .calculating {
            animation: calculating 1s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-bar">
            <div class="nav-left">
                <button class="back-btn" onclick="window.location.href='index.html'">‚Üê Back</button>
                <h1 class="page-title">Financial Formula Calculator</h1>
            </div>
            <div class="nav-actions">
                <div class="mode-selector">
                    <button class="mode-btn active" data-mode="cfa" onclick="switchMode('cfa')">
                        üìä CFA Mode
                    </button>
                    <button class="mode-btn" data-mode="admin" onclick="switchMode('admin')">
                        ‚öôÔ∏è Admin Mode
                    </button>
                </div>
            </div>
        </div>

        <div class="main-layout">
            <!-- Formula Selection Panel -->
            <div class="formula-panel">
                <div class="section-title">üìä Formula Library</div>
                
                <div class="formula-category">
                    <div class="category-title">Risk Management</div>
                    <div class="formula-item" data-formula="var" data-complexity="intermediate">
                        <span class="formula-name">Value at Risk (VaR)</span>
                        <span class="formula-complexity complexity-intermediate">INT</span>
                    </div>
                    <div class="formula-item" data-formula="es" data-complexity="advanced">
                        <span class="formula-name">Expected Shortfall</span>
                        <span class="formula-complexity complexity-advanced">ADV</span>
                    </div>
                    <div class="formula-item" data-formula="beta" data-complexity="basic">
                        <span class="formula-name">Beta Coefficient</span>
                        <span class="formula-complexity complexity-basic">BASIC</span>
                    </div>
                </div>

                <div class="formula-category">
                    <div class="category-title">Options Pricing</div>
                    <div class="formula-item" data-formula="call" data-complexity="advanced">
                        <span class="formula-name">Call Option (Black-Scholes)</span>
                        <span class="formula-complexity complexity-advanced">ADV</span>
                    </div>
                    <div class="formula-item" data-formula="put" data-complexity="advanced">
                        <span class="formula-name">Put Option (Black-Scholes)</span>
                        <span class="formula-complexity complexity-advanced">ADV</span>
                    </div>
                    <div class="formula-item" data-formula="delta" data-complexity="intermediate">
                        <span class="formula-name">Delta Greek</span>
                        <span class="formula-complexity complexity-intermediate">INT</span>
                    </div>
                    <div class="formula-item" data-formula="gamma" data-complexity="intermediate">
                        <span class="formula-name">Gamma Greek</span>
                        <span class="formula-complexity complexity-intermediate">INT</span>
                    </div>
                    <div class="formula-item" data-formula="theta" data-complexity="intermediate">
                        <span class="formula-name">Theta Greek</span>
                        <span class="formula-complexity complexity-intermediate">INT</span>
                    </div>
                </div>

                <div class="formula-category">
                    <div class="category-title">Performance Metrics</div>
                    <div class="formula-item" data-formula="sharpe" data-complexity="basic">
                        <span class="formula-name">Sharpe Ratio</span>
                        <span class="formula-complexity complexity-basic">BASIC</span>
                    </div>
                    <div class="formula-item" data-formula="sortino" data-complexity="intermediate">
                        <span class="formula-name">Sortino Ratio</span>
                        <span class="formula-complexity complexity-intermediate">INT</span>
                    </div>
                    <div class="formula-item" data-formula="treynor" data-complexity="basic">
                        <span class="formula-name">Treynor Ratio</span>
                        <span class="formula-complexity complexity-basic">BASIC</span>
                    </div>
                    <div class="formula-item" data-formula="alpha" data-complexity="intermediate">
                        <span class="formula-name">Jensen's Alpha</span>
                        <span class="formula-complexity complexity-intermediate">INT</span>
                    </div>
                </div>

                <div class="formula-category">
                    <div class="category-title">Fixed Income</div>
                    <div class="formula-item" data-formula="duration" data-complexity="intermediate">
                        <span class="formula-name">Modified Duration</span>
                        <span class="formula-complexity complexity-intermediate">INT</span>
                    </div>
                    <div class="formula-item" data-formula="convexity" data-complexity="advanced">
                        <span class="formula-name">Convexity</span>
                        <span class="formula-complexity complexity-advanced">ADV</span>
                    </div>
                    <div class="formula-item" data-formula="ytm" data-complexity="intermediate">
                        <span class="formula-name">Yield to Maturity</span>
                        <span class="formula-complexity complexity-intermediate">INT</span>
                    </div>
                </div>

                <div class="formula-category">
                    <div class="category-title">Basel III Ratios</div>
                    <div class="formula-item" data-formula="lcr" data-complexity="advanced">
                        <span class="formula-name">Liquidity Coverage Ratio</span>
                        <span class="formula-complexity complexity-advanced">ADV</span>
                    </div>
                    <div class="formula-item" data-formula="nsfr" data-complexity="advanced">
                        <span class="formula-name">Net Stable Funding Ratio</span>
                        <span class="formula-complexity complexity-advanced">ADV</span>
                    </div>
                    <div class="formula-item" data-formula="tier1" data-complexity="intermediate">
                        <span class="formula-name">Tier 1 Capital Ratio</span>
                        <span class="formula-complexity complexity-intermediate">INT</span>
                    </div>
                </div>
            </div>

            <!-- Calculation Area -->
            <div class="calculation-area">
                <div class="section-title" id="formula-title">Select a Formula</div>
                
                <!-- Scenario Selector -->
                <div class="scenario-selector" id="scenario-selector" style="display: none;">
                    <div class="parameter-type-title">Market Scenario</div>
                    <div class="scenario-grid">
                        <button class="scenario-btn active" data-scenario="normal">Normal Market</button>
                        <button class="scenario-btn" data-scenario="stress">Stress Test</button>
                        <button class="scenario-btn" data-scenario="crisis">Crisis</button>
                        <button class="scenario-btn" data-scenario="bull">Bull Market</button>
                        <button class="scenario-btn" data-scenario="bear">Bear Market</button>
                        <button class="scenario-btn" data-scenario="volatile">High Volatility</button>
                    </div>
                </div>

                <!-- Formula Equation Display -->
                <div class="formula-equation" id="formula-equation" style="display: none;">
                    <!-- Dynamic formula equation -->
                </div>

                <!-- Fixed/Default Parameters -->
                <div class="parameter-section" id="fixed-params" style="display: none;">
                    <div class="parameter-header">
                        <div class="parameter-type-title">üîí Fixed/Default Parameters</div>
                        <div class="parameter-count" id="fixed-count">0 parameters</div>
                    </div>
                    <div class="parameter-grid" id="fixed-params-grid">
                        <!-- Dynamic fixed parameters -->
                    </div>
                </div>

                <!-- Scenario-Based Parameters -->
                <div class="parameter-section" id="scenario-params" style="display: none;">
                    <div class="parameter-header">
                        <div class="parameter-type-title">üéØ Scenario Parameters</div>
                        <div class="parameter-count" id="scenario-count">0 parameters</div>
                    </div>
                    <div class="parameter-grid" id="scenario-params-grid">
                        <!-- Dynamic scenario parameters -->
                    </div>
                </div>

                <!-- Chained Calculation Parameters -->
                <div class="parameter-section" id="chained-params" style="display: none;">
                    <div class="parameter-header">
                        <div class="parameter-type-title">üîó Chained Calculations</div>
                        <div class="parameter-count" id="chained-count">0 parameters</div>
                    </div>
                    <div class="chain-indicator" id="chain-indicator">
                        <span class="chain-arrow">‚Üí</span>
                        <span>Values automatically calculated from previous results</span>
                    </div>
                    <div class="parameter-grid" id="chained-params-grid">
                        <!-- Dynamic chained parameters -->
                    </div>
                </div>

                <!-- User Input Parameters -->
                <div class="parameter-section" id="user-params" style="display: none;">
                    <div class="parameter-header">
                        <div class="parameter-type-title">‚úèÔ∏è User Inputs</div>
                        <div class="parameter-count" id="user-count">0 parameters</div>
                    </div>
                    <div class="parameter-grid" id="user-params-grid">
                        <!-- Dynamic user parameters -->
                    </div>
                </div>

                <button class="calculate-btn" id="calculate-btn" onclick="performCalculation()" disabled>
                    Calculate Result
                </button>
            </div>

            <!-- Results Panel -->
            <div class="results-panel">
                <div class="section-title">üìà Calculation Results</div>
                <div id="results-container">
                    <div style="text-align: center; color: rgba(255, 255, 255, 0.5); margin-top: 50px;">
                        Select a formula to see results
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentFormula = null;
        let currentScenario = 'normal';
        let calculationHistory = [];
        let chainedValues = new Map();
        let userMode = 'cfa'; // Default to CFA mode

        // Formula definitions with parameter types
        const formulaDefinitions = {
            'var': {
                name: 'Value at Risk (VaR)',
                equation: 'VaR = Œº + (œÉ √ó Z_Œ±) √ó ‚àöt',
                description: 'Maximum potential loss at a given confidence level',
                fixedParams: {
                    confidence_level: { value: 0.95, description: 'Confidence level (95%)', min: 0.8, max: 0.99 },
                    time_horizon: { value: 1, description: 'Time horizon in days', min: 1, max: 252 }
                },
                scenarioParams: {
                    volatility_adjustment: { normal: 1.0, stress: 1.5, crisis: 2.0, bull: 0.8, bear: 1.3, volatile: 1.8 }
                },
                chainedParams: {
                    portfolio_beta: { source: 'beta', description: 'Portfolio beta from beta calculation' }
                },
                userParams: {
                    portfolio_value: { description: 'Portfolio value ($)', default: 1000000, min: 1000 },
                    expected_return: { description: 'Expected return (%)', default: 8.0, min: -50, max: 50 },
                    volatility: { description: 'Portfolio volatility (%)', default: 15.0, min: 1, max: 100 }
                }
            },
            'sharpe': {
                name: 'Sharpe Ratio',
                equation: 'Sharpe = (R_p - R_f) / œÉ_p',
                description: 'Risk-adjusted return measure',
                fixedParams: {
                    days_per_year: { value: 252, description: 'Trading days per year', min: 250, max: 365 }
                },
                scenarioParams: {
                    risk_free_rate: { normal: 3.0, stress: 1.0, crisis: 0.5, bull: 3.5, bear: 2.0, volatile: 2.5 }
                },
                chainedParams: {
                    portfolio_return: { source: 'var', description: 'Portfolio return from VaR calculation' }
                },
                userParams: {
                    portfolio_return: { description: 'Portfolio return (%)', default: 10.0, min: -50, max: 50 },
                    portfolio_volatility: { description: 'Portfolio volatility (%)', default: 15.0, min: 1, max: 100 }
                }
            },
            'call': {
                name: 'Call Option (Black-Scholes)',
                equation: 'C = S‚ÇÄN(d‚ÇÅ) - Ke^(-rT)N(d‚ÇÇ)',
                description: 'European call option price using Black-Scholes model',
                fixedParams: {
                    option_type: { value: 'call', description: 'Option type (call)', readonly: true }
                },
                scenarioParams: {
                    interest_rate: { normal: 3.0, stress: 1.0, crisis: 0.25, bull: 4.0, bear: 2.0, volatile: 2.5 },
                    volatility_multiplier: { normal: 1.0, stress: 1.4, crisis: 2.0, bull: 0.9, bear: 1.2, volatile: 1.8 }
                },
                chainedParams: {
                    underlying_volatility: { source: 'var', description: 'Volatility from VaR calculation' }
                },
                userParams: {
                    spot_price: { description: 'Current stock price ($)', default: 100, min: 0.01 },
                    strike_price: { description: 'Strike price ($)', default: 105, min: 0.01 },
                    time_to_expiry: { description: 'Time to expiry (years)', default: 0.25, min: 0.001, max: 5 },
                    volatility: { description: 'Implied volatility (%)', default: 20, min: 1, max: 200 }
                }
            },
            'duration': {
                name: 'Modified Duration',
                equation: 'Modified Duration = Macaulay Duration / (1 + YTM/n)',
                description: 'Price sensitivity of bond to yield changes',
                fixedParams: {
                    compounding_frequency: { value: 2, description: 'Compounding frequency (semi-annual)', min: 1, max: 12 }
                },
                scenarioParams: {
                    yield_environment: { normal: 0.0, stress: 2.0, crisis: -1.0, bull: 0.5, bear: 1.5, volatile: 1.0 }
                },
                chainedParams: {
                    market_yield: { source: 'ytm', description: 'Yield from YTM calculation' }
                },
                userParams: {
                    face_value: { description: 'Face value ($)', default: 1000, min: 100 },
                    coupon_rate: { description: 'Coupon rate (%)', default: 5.0, min: 0, max: 20 },
                    yield_to_maturity: { description: 'Yield to maturity (%)', default: 4.5, min: 0, max: 30 },
                    years_to_maturity: { description: 'Years to maturity', default: 5, min: 0.1, max: 30 }
                }
            },
            'beta': {
                name: 'Beta Coefficient',
                equation: 'Œ≤ = Cov(R_asset, R_market) / Var(R_market)',
                description: 'Systematic risk measure relative to market',
                fixedParams: {
                    calculation_period: { value: 252, description: 'Calculation period (days)', min: 30, max: 1260 }
                },
                scenarioParams: {
                    market_correlation: { normal: 1.0, stress: 1.2, crisis: 1.5, bull: 0.9, bear: 1.1, volatile: 1.3 }
                },
                chainedParams: {},
                userParams: {
                    asset_return: { description: 'Asset return (%)', default: 12.0, min: -50, max: 100 },
                    market_return: { description: 'Market return (%)', default: 10.0, min: -50, max: 100 },
                    asset_volatility: { description: 'Asset volatility (%)', default: 18.0, min: 1, max: 100 },
                    market_volatility: { description: 'Market volatility (%)', default: 15.0, min: 1, max: 100 }
                }
            },
            'lcr': {
                name: 'Liquidity Coverage Ratio',
                equation: 'LCR = HQLA / Net Cash Outflows (30 days)',
                description: 'Basel III liquidity requirement (min 100%)',
                fixedParams: {
                    minimum_requirement: { value: 100, description: 'Minimum LCR requirement (%)', readonly: true },
                    stress_period: { value: 30, description: 'Stress period (days)', readonly: true }
                },
                scenarioParams: {
                    stress_multiplier: { normal: 1.0, stress: 1.3, crisis: 1.5, bull: 0.9, bear: 1.2, volatile: 1.4 }
                },
                chainedParams: {},
                userParams: {
                    hqla: { description: 'High Quality Liquid Assets ($M)', default: 500, min: 0 },
                    cash_outflows: { description: 'Net cash outflows 30d ($M)', default: 400, min: 0 },
                    deposits: { description: 'Customer deposits ($M)', default: 2000, min: 0 },
                    credit_facilities: { description: 'Committed credit facilities ($M)', default: 300, min: 0 }
                }
            }
        };

        // Initialize the calculator
        document.addEventListener('DOMContentLoaded', function() {
            // Get user mode from localStorage or URL parameter
            const urlParams = new URLSearchParams(window.location.search);
            const modeFromUrl = urlParams.get('mode');
            userMode = localStorage.getItem('userMode') || modeFromUrl || 'cfa';
            
            setupFormulaListeners();
            setupScenarioListeners();
            loadCalculationHistory();
            updateUIForUserMode();
        });

        function setupFormulaListeners() {
            document.querySelectorAll('.formula-item').forEach(item => {
                item.addEventListener('click', function() {
                    // Remove active class from all items
                    document.querySelectorAll('.formula-item').forEach(i => i.classList.remove('active'));
                    
                    // Add active class to clicked item
                    this.classList.add('active');
                    
                    // Load formula
                    const formulaId = this.dataset.formula;
                    loadFormula(formulaId);
                });
            });
        }

        function setupScenarioListeners() {
            document.querySelectorAll('.scenario-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // Update active scenario
                    document.querySelectorAll('.scenario-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    currentScenario = this.dataset.scenario;
                    
                    // Reload parameters with new scenario
                    if (currentFormula) {
                        loadFormulaParameters(currentFormula);
                    }
                });
            });
        }

        function loadFormula(formulaId) {
            currentFormula = formulaId;
            const formula = formulaDefinitions[formulaId];
            
            if (!formula) {
                console.error('Formula not found:', formulaId);
                return;
            }

            // Update title and equation
            document.getElementById('formula-title').textContent = formula.name;
            document.getElementById('formula-equation').innerHTML = `
                <strong>Formula:</strong> ${formula.equation}<br>
                <em>${formula.description}</em>
            `;
            document.getElementById('formula-equation').style.display = 'block';
            document.getElementById('scenario-selector').style.display = 'block';

            // Load parameters
            loadFormulaParameters(formulaId);
            
            // Enable calculate button
            document.getElementById('calculate-btn').disabled = false;
        }

        function loadFormulaParameters(formulaId) {
            const formula = formulaDefinitions[formulaId];
            
            // Load fixed parameters
            loadParameterSection('fixed', formula.fixedParams, 'Fixed/Default');
            
            // Load scenario parameters
            loadParameterSection('scenario', formula.scenarioParams, 'Scenario-Based');
            
            // Load chained parameters
            loadParameterSection('chained', formula.chainedParams, 'Chained Calculations');
            
            // Load user parameters
            loadParameterSection('user', formula.userParams, 'User Inputs');
        }

        function loadParameterSection(type, params, title) {
            const section = document.getElementById(`${type}-params`);
            const grid = document.getElementById(`${type}-params-grid`);
            const count = document.getElementById(`${type}-count`);
            
            const paramKeys = Object.keys(params || {});
            
            if (paramKeys.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            count.textContent = `${paramKeys.length} parameter${paramKeys.length !== 1 ? 's' : ''}`;
            grid.innerHTML = '';

            paramKeys.forEach(key => {
                const param = params[key];
                const paramDiv = document.createElement('div');
                paramDiv.className = 'parameter-item';
                
                let value = '';
                let disabled = false;
                let sourceClass = `source-${type}`;
                let sourceText = type.toUpperCase();

                // Get parameter value based on type
                if (type === 'fixed') {
                    value = param.value;
                    disabled = param.readonly || false;
                } else if (type === 'scenario') {
                    value = param[currentScenario] || param.normal || 0;
                    disabled = true; // Scenario params are auto-calculated
                } else if (type === 'chained') {
                    value = chainedValues.get(key) || `From ${param.source}`;
                    disabled = true; // Chained params come from other calculations
                } else if (type === 'user') {
                    value = param.default || '';
                    disabled = false;
                }

                paramDiv.innerHTML = `
                    <div class="parameter-label">
                        ${key.replace(/_/g, ' ').toUpperCase()}
                        <span class="parameter-source ${sourceClass}">${sourceText}</span>
                    </div>
                    <input type="number" 
                           class="parameter-input" 
                           value="${value}" 
                           ${disabled ? 'disabled' : ''}
                           ${param.min !== undefined ? `min="${param.min}"` : ''}
                           ${param.max !== undefined ? `max="${param.max}"` : ''}
                           ${param.step !== undefined ? `step="${param.step}"` : 'step="0.01"'}
                           data-param="${key}"
                           data-type="${type}">
                    <div class="parameter-description">${param.description || 'Parameter description'}</div>
                `;

                grid.appendChild(paramDiv);
            });
        }

        async function performCalculation() {
            const btn = document.getElementById('calculate-btn');
            btn.disabled = true;
            btn.classList.add('calculating');
            btn.textContent = 'Calculating...';

            try {
                // Collect all parameter values
                const parameters = collectParameterValues();
                
                // Make API call to calculation engine
                const response = await fetch('/api/configure', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'test-formula',
                        userMode: userMode,
                        data: {
                            formula: currentFormula,
                            scenario: currentScenario,
                            parameters: parameters
                        }
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    displayCalculationResult(result);
                    
                    // Store result for potential chaining
                    if (result.result && typeof result.result.value === 'number') {
                        chainedValues.set(`${currentFormula}_result`, result.result.value);
                    }
                    
                    // Add to history
                    calculationHistory.unshift({
                        formula: currentFormula,
                        scenario: currentScenario,
                        result: result.result,
                        timestamp: new Date().toISOString(),
                        parameters: parameters
                    });
                    
                    // Keep only last 10 calculations
                    if (calculationHistory.length > 10) {
                        calculationHistory = calculationHistory.slice(0, 10);
                    }
                } else {
                    displayCalculationError(result.error || 'Calculation failed');
                }

            } catch (error) {
                console.error('Calculation error:', error);
                displayCalculationError('Network error occurred');
            } finally {
                btn.disabled = false;
                btn.classList.remove('calculating');
                btn.textContent = 'Calculate Result';
            }
        }

        function collectParameterValues() {
            const parameters = {};
            
            // Collect all parameter inputs
            document.querySelectorAll('.parameter-input').forEach(input => {
                const paramName = input.dataset.param;
                const paramType = input.dataset.type;
                const value = parseFloat(input.value) || input.value;
                
                parameters[paramName] = {
                    value: value,
                    type: paramType,
                    source: paramType === 'chained' ? 'previous_calculation' : 'user_input'
                };
            });

            return parameters;
        }

        function displayCalculationResult(apiResult) {
            const container = document.getElementById('results-container');
            const formula = formulaDefinitions[currentFormula];
            const result = apiResult.result;

            const resultDiv = document.createElement('div');
            resultDiv.className = 'result-item';
            
            // Format the result value
            let formattedValue = '';
            let interpretation = '';
            
            if (typeof result.value === 'number') {
                if (currentFormula === 'var') {
                    formattedValue = `$${result.value.toLocaleString()}`;
                    interpretation = `At 95% confidence, maximum loss is ${formattedValue}`;
                } else if (currentFormula === 'sharpe') {
                    formattedValue = result.value.toFixed(3);
                    interpretation = result.value > 1 ? 'Good risk-adjusted return' : 'Poor risk-adjusted return';
                } else if (currentFormula.includes('call') || currentFormula.includes('put')) {
                    formattedValue = `$${result.value.toFixed(2)}`;
                    interpretation = `Option premium: ${formattedValue}`;
                } else if (currentFormula === 'lcr') {
                    formattedValue = `${result.value.toFixed(1)}%`;
                    interpretation = result.value >= 100 ? 'Meets Basel III requirement' : 'Below required minimum';
                } else {
                    formattedValue = result.value.toFixed(4);
                    interpretation = `Calculated ${formula.name}: ${formattedValue}`;
                }
            } else {
                formattedValue = result.value.toString();
                interpretation = 'Calculation completed';
            }

            resultDiv.innerHTML = `
                <div class="result-header">
                    <div class="result-label">${formula.name}</div>
                    <div class="result-timestamp">${new Date().toLocaleTimeString()}</div>
                </div>
                <div class="result-value">${formattedValue}</div>
                <div class="result-interpretation">${interpretation}</div>
                <div class="result-metadata">
                    <div class="metadata-item">
                        <span class="metadata-label">Scenario:</span> ${currentScenario}
                    </div>
                    <div class="metadata-item">
                        <span class="metadata-label">Execution:</span> ${result.executionTime || 0}ms
                    </div>
                    <div class="metadata-item">
                        <span class="metadata-label">Complexity:</span> ${document.querySelector('.formula-item.active')?.dataset.complexity || 'N/A'}
                    </div>
                    <div class="metadata-item">
                        <span class="metadata-label">Confidence:</span> ${result.confidence || 'High'}
                    </div>
                </div>
            `;

            // Insert at the top
            container.insertBefore(resultDiv, container.firstChild);
            
            // Remove old results if more than 5
            const results = container.querySelectorAll('.result-item');
            if (results.length > 5) {
                for (let i = 5; i < results.length; i++) {
                    results[i].remove();
                }
            }
        }

        function displayCalculationError(error) {
            const container = document.getElementById('results-container');
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'result-item';
            errorDiv.style.borderColor = '#ff453a';
            
            errorDiv.innerHTML = `
                <div class="result-header">
                    <div class="result-label">Calculation Error</div>
                    <div class="result-timestamp">${new Date().toLocaleTimeString()}</div>
                </div>
                <div class="result-value" style="color: #ff453a;">Error</div>
                <div class="result-interpretation">${error}</div>
            `;

            container.insertBefore(errorDiv, container.firstChild);
        }

        function loadCalculationHistory() {
            // Could load from localStorage or backend
            const stored = localStorage.getItem('calculationHistory');
            if (stored) {
                try {
                    calculationHistory = JSON.parse(stored);
                } catch (e) {
                    console.warn('Failed to load calculation history');
                }
            }
        }

        // Save calculation history periodically
        setInterval(() => {
            localStorage.setItem('calculationHistory', JSON.stringify(calculationHistory));
        }, 30000);

        function updateUIForUserMode() {
            const pageTitle = document.querySelector('.page-title');
            
            if (userMode === 'admin') {
                pageTitle.textContent = 'Formula Calculator - System Administrator';
                // Show admin-specific features
                document.body.classList.add('admin-mode');
            } else {
                pageTitle.textContent = 'Financial Formula Calculator - CFA Professional';
                // Show CFA-specific features
                document.body.classList.add('cfa-mode');
            }
            
            // Update available formulas based on mode
            filterFormulasByMode();
        }

        function filterFormulasByMode() {
            const formulaItems = document.querySelectorAll('.formula-item');
            
            formulaItems.forEach(item => {
                const formula = item.dataset.formula;
                
                // All formulas available to admin, subset for CFA
                if (userMode === 'cfa') {
                    // Hide system/admin specific formulas in CFA mode
                    const cfaFormulas = ['var', 'es', 'beta', 'call', 'put', 'delta', 'gamma', 'theta', 
                                       'sharpe', 'sortino', 'treynor', 'alpha', 'duration', 'convexity', 
                                       'ytm', 'lcr', 'nsfr', 'tier1'];
                    
                    if (!cfaFormulas.includes(formula)) {
                        item.style.display = 'none';
                    }
                } else {
                    // Show all formulas in admin mode
                    item.style.display = 'flex';
                }
            });
        }
    </script>
    <script src="shared-header.js"></script>
</body>
</html>
