-- Fix Minor Issues for Production Readiness (Safe Version)
-- Migration: 20250119060001_fix_minor_issues_safe.sql

-- 1. Handle dependent views for news_articles
-- Drop dependent views first
DROP VIEW IF EXISTS public.unified_knowledge_graph CASCADE;
DROP VIEW IF EXISTS public.gql_news_articles CASCADE;
DROP VIEW IF EXISTS public.gql_news_feed CASCADE;

-- 2. Fix market_data date field constraint
ALTER TABLE public.market_data 
ALTER COLUMN date DROP NOT NULL;

-- Add default value for date field
ALTER TABLE public.market_data 
ALTER COLUMN date SET DEFAULT CURRENT_DATE;

-- 3. Fix news_articles importance_score data type
-- First, convert existing decimal values to integers (multiply by 100)
UPDATE public.news_articles 
SET importance_score = ROUND(importance_score * 100)
WHERE importance_score IS NOT NULL AND importance_score < 1;

-- Change column type to INTEGER
ALTER TABLE public.news_articles 
ALTER COLUMN importance_score TYPE INTEGER USING ROUND(importance_score)::INTEGER;

-- Add constraint for valid range (0-100)
ALTER TABLE public.news_articles 
ADD CONSTRAINT importance_score_range 
CHECK (importance_score >= 0 AND importance_score <= 100);

-- 4. Recreate dropped views
-- Recreate gql_news_articles view
CREATE OR REPLACE VIEW public.gql_news_articles AS
SELECT 
    id,
    title,
    summary,
    content,
    source,
    author,
    url,
    published_at,
    category,
    sentiment_score,
    importance_score,
    view_count,
    engagement_score,
    entity_count,
    created_at,
    updated_at
FROM public.news_articles;

-- Recreate gql_news_feed view
CREATE OR REPLACE VIEW public.gql_news_feed AS
SELECT 
    n.id,
    n.title,
    n.summary,
    n.source,
    n.published_at,
    n.sentiment_score,
    n.importance_score,
    n.category,
    n.view_count,
    ARRAY_AGG(DISTINCT ns.symbol) FILTER (WHERE ns.symbol IS NOT NULL) as symbols
FROM public.news_articles n
LEFT JOIN public.news_article_symbols ns ON n.id = ns.news_article_id
GROUP BY n.id, n.title, n.summary, n.source, n.published_at, 
         n.sentiment_score, n.importance_score, n.category, n.view_count
ORDER BY n.published_at DESC;

-- Recreate unified_knowledge_graph view
CREATE OR REPLACE VIEW public.unified_knowledge_graph AS
SELECT 
    'USER_' || u.id::text as entity_id,
    'USER' as entity_type,
    u.username as entity_name,
    jsonb_build_object(
        'email', u.email,
        'full_name', u.full_name,
        'user_type', u.user_type,
        'subscription_tier', u.subscription_tier
    ) as properties,
    array[]::text[] as relationships,
    u.created_at,
    u.updated_at
FROM public.users u

UNION ALL

SELECT 
    'AGENT_' || a.id::text as entity_id,
    'AGENT' as entity_type,
    a.agent_name as entity_name,
    jsonb_build_object(
        'agent_type', a.agent_type,
        'description', a.description,
        'endpoint_url', a.endpoint_url,
        'ord_id', a.ord_id
    ) as properties,
    array[]::text[] as relationships,
    a.created_at,
    a.updated_at
FROM public.a2a_agents a

UNION ALL

SELECT 
    'NEWS_' || n.id::text as entity_id,
    'NEWS' as entity_type,
    n.title as entity_name,
    jsonb_build_object(
        'source', n.source,
        'category', n.category,
        'sentiment_score', n.sentiment_score,
        'importance_score', n.importance_score,
        'view_count', n.view_count
    ) as properties,
    array[]::text[] as relationships,
    n.created_at,
    n.updated_at
FROM public.news_articles n;

-- 5. Fix user_id format issue - add username constraint
DO $$
BEGIN
    -- Check if constraint doesn't exist
    IF NOT EXISTS (
        SELECT 1 FROM pg_constraint 
        WHERE conname = 'username_format' 
        AND conrelid = 'public.users'::regclass
    ) THEN
        ALTER TABLE public.users 
        ADD CONSTRAINT username_format 
        CHECK (username ~ '^[a-zA-Z0-9_]{3,30}$');
    END IF;
END $$;

-- 6. Add helpful defaults for other fields
-- Market data defaults
ALTER TABLE public.market_data 
ALTER COLUMN timestamp SET DEFAULT NOW();

-- News articles defaults
ALTER TABLE public.news_articles 
ALTER COLUMN published_at SET DEFAULT NOW(),
ALTER COLUMN created_at SET DEFAULT NOW(),
ALTER COLUMN view_count SET DEFAULT 0,
ALTER COLUMN engagement_score SET DEFAULT 0,
ALTER COLUMN entity_count SET DEFAULT 0;

-- 7. Create helper function for market data insertion
CREATE OR REPLACE FUNCTION public.insert_market_data(
    p_symbol VARCHAR,
    p_price NUMERIC,
    p_volume BIGINT DEFAULT NULL,
    p_exchange VARCHAR DEFAULT 'UNKNOWN',
    p_asset_type VARCHAR DEFAULT 'stock'
)
RETURNS public.market_data
LANGUAGE plpgsql
AS $$
DECLARE
    v_result public.market_data;
BEGIN
    INSERT INTO public.market_data (
        symbol,
        price,
        volume,
        exchange,
        asset_type,
        date,
        timestamp,
        open_price,
        high_price,
        low_price,
        close_price,
        adjusted_close,
        currency,
        data_source
    ) VALUES (
        p_symbol,
        p_price,
        p_volume,
        p_exchange,
        p_asset_type,
        CURRENT_DATE,
        NOW(),
        p_price, -- Use current price as open
        p_price, -- Use current price as high
        p_price, -- Use current price as low
        p_price, -- Use current price as close
        p_price, -- Use current price as adjusted close
        'USD',
        'manual'
    )
    RETURNING * INTO v_result;
    
    RETURN v_result;
END;
$$;

-- 8. Create helper function for news article insertion
CREATE OR REPLACE FUNCTION public.insert_news_article(
    p_title VARCHAR,
    p_summary TEXT,
    p_content TEXT DEFAULT NULL,
    p_source VARCHAR DEFAULT 'manual',
    p_sentiment_score NUMERIC DEFAULT 0,
    p_importance_score INTEGER DEFAULT 50
)
RETURNS public.news_articles
LANGUAGE plpgsql
AS $$
DECLARE
    v_result public.news_articles;
BEGIN
    INSERT INTO public.news_articles (
        title,
        summary,
        content,
        source,
        sentiment_score,
        importance_score,
        author,
        category,
        published_at,
        created_at
    ) VALUES (
        p_title,
        p_summary,
        COALESCE(p_content, p_summary),
        p_source,
        p_sentiment_score,
        p_importance_score,
        'System',
        'General',
        NOW(),
        NOW()
    )
    RETURNING * INTO v_result;
    
    RETURN v_result;
END;
$$;

-- 9. Add sample portfolio data (if tables exist)
DO $$
BEGIN
    -- Check if portfolio_holdings table exists
    IF EXISTS (SELECT 1 FROM information_schema.tables 
               WHERE table_schema = 'public' 
               AND table_name = 'portfolio_holdings') THEN
        INSERT INTO public.portfolio_holdings (
            user_id,
            symbol,
            quantity,
            average_cost,
            current_price,
            market_value,
            unrealized_pnl,
            asset_type,
            exchange,
            currency,
            last_updated
        ) VALUES 
            (1, 'AAPL', 100, 150.00, 175.00, 17500.00, 2500.00, 'stock', 'NASDAQ', 'USD', NOW()),
            (1, 'GOOGL', 50, 2800.00, 2950.00, 147500.00, 7500.00, 'stock', 'NASDAQ', 'USD', NOW()),
            (1, 'MSFT', 75, 300.00, 380.00, 28500.00, 6000.00, 'stock', 'NASDAQ', 'USD', NOW()),
            (2, 'BTC', 0.5, 30000.00, 45000.00, 22500.00, 7500.00, 'crypto', 'CRYPTO', 'USD', NOW()),
            (2, 'ETH', 5, 2000.00, 2500.00, 12500.00, 2500.00, 'crypto', 'CRYPTO', 'USD', NOW())
        ON CONFLICT DO NOTHING;
    END IF;
END $$;

-- 10. Add sample bond data (if table exists)
DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM information_schema.tables 
               WHERE table_schema = 'public' 
               AND table_name = 'bond_data') THEN
        INSERT INTO public.bond_data (
            symbol,
            issuer,
            maturity_date,
            coupon_rate,
            yield_to_maturity,
            price,
            face_value,
            rating,
            currency,
            last_updated
        ) VALUES 
            ('US10Y', 'US Treasury', '2034-01-15', 4.25, 4.30, 98.50, 1000, 'AAA', 'USD', NOW()),
            ('US30Y', 'US Treasury', '2054-01-15', 4.50, 4.55, 97.25, 1000, 'AAA', 'USD', NOW()),
            ('AAPL4.5', 'Apple Inc', '2028-05-15', 4.50, 4.35, 101.25, 1000, 'AA+', 'USD', NOW())
        ON CONFLICT DO NOTHING;
    END IF;
END $$;

-- 11. Add sample forex rates (if table exists)
DO $$
BEGIN
    IF EXISTS (SELECT 1 FROM information_schema.tables 
               WHERE table_schema = 'public' 
               AND table_name = 'forex_rates') THEN
        INSERT INTO public.forex_rates (
            base_currency,
            quote_currency,
            rate,
            bid,
            ask,
            timestamp
        ) VALUES 
            ('USD', 'EUR', 0.92, 0.9198, 0.9202, NOW()),
            ('USD', 'GBP', 0.79, 0.7898, 0.7902, NOW()),
            ('USD', 'JPY', 148.50, 148.48, 148.52, NOW()),
            ('EUR', 'GBP', 0.86, 0.8598, 0.8602, NOW())
        ON CONFLICT DO NOTHING;
    END IF;
END $$;

-- 12. Grant permissions on helper functions
GRANT EXECUTE ON FUNCTION public.insert_market_data TO anon, authenticated;
GRANT EXECUTE ON FUNCTION public.insert_news_article TO anon, authenticated;

-- Success notification
DO $$
BEGIN
    RAISE NOTICE 'Minor issues fixed successfully!';
    RAISE NOTICE '- Market data date constraint relaxed';
    RAISE NOTICE '- News importance_score converted to INTEGER';
    RAISE NOTICE '- Helper functions created for easy insertion';
    RAISE NOTICE '- Sample portfolio, bond, and forex data added';
    RAISE NOTICE '- All dependent views recreated';
END $$;